<div class="form-builder">
  <!-- Header -->
  <header class="builder-header">
    <h1>üõ†Ô∏è Dynamic Form Builder</h1>
    <div class="header-actions">
      <label class="toggle-label">
        <input
          type="checkbox"
          [checked]="multiStepMode()"
          (change)="toggleMultiStepMode()"
        >
        <span>üìã Multi-Step Mode</span>
      </label>
      <button class="btn btn-secondary" (click)="clearForm()">üóëÔ∏è Clear</button>
      <button class="btn btn-secondary" (click)="fileInput.click()">üì• Import</button>
      <button class="btn btn-secondary" (click)="exportSchema()">üì§ Export</button>
      <button class="btn btn-primary" (click)="generateTypeScript()">‚ö° Generate TS</button>
      <input #fileInput type="file" accept=".json" (change)="importSchema($event)" style="display: none">
    </div>
  </header>

  <!-- Three-panel layout -->
  <div class="builder-content">
    <!-- Panel 1: Visual Editor (Field Palette & Tree) -->
    <div class="panel visual-editor">
      <div class="panel-header">
        <h2>üìã Visual Editor</h2>
      </div>

      <div class="panel-body">
        <!-- Form Settings -->
        <section class="form-settings-section">
          <h3>‚öôÔ∏è Form Settings</h3>
          <div class="settings-form">
            <!-- Form Metadata -->
            <div class="settings-group">
              <h4>üìù Form Metadata</h4>

              <div class="form-group">
                <label>Form Title</label>
                <input
                  type="text"
                  [value]="schema().title"
                  (input)="updateFormProperty('title', $any($event.target).value)"
                  class="form-control"
                  placeholder="Enter form title"
                >
              </div>

              <div class="form-group">
                <label>Description</label>
                <textarea
                  [value]="schema().description || ''"
                  (input)="updateFormProperty('description', $any($event.target).value)"
                  class="form-control"
                  rows="2"
                  placeholder="Optional form description"
                ></textarea>
              </div>
            </div>

            <!-- Submission Configuration -->
            <div class="settings-group">
              <h4>üì§ Submission Configuration</h4>

              <div class="form-group">
                <label>API Endpoint</label>
                <input
                  type="text"
                  [value]="schema().submission?.endpoint || ''"
                  (input)="updateSubmissionProperty('endpoint', $any($event.target).value || undefined)"
                  class="form-control"
                  placeholder="https://api.example.com/submit"
                >
                <small class="text-muted">Leave empty to display data locally</small>
              </div>

              <div class="form-group">
                <label>HTTP Method</label>
                <select
                  [value]="schema().submission?.method || 'POST'"
                  (change)="updateSubmissionProperty('method', $any($event.target).value)"
                  class="form-control"
                >
                  <option value="POST">POST</option>
                  <option value="PUT">PUT</option>
                  <option value="PATCH">PATCH</option>
                </select>
              </div>

              <div class="form-group">
                <label>Success Message</label>
                <input
                  type="text"
                  [value]="schema().submission?.successMessage || ''"
                  (input)="updateSubmissionProperty('successMessage', $any($event.target).value || undefined)"
                  class="form-control"
                  placeholder="Form submitted successfully!"
                >
              </div>

              <div class="form-group">
                <label>Error Message</label>
                <input
                  type="text"
                  [value]="schema().submission?.errorMessage || ''"
                  (input)="updateSubmissionProperty('errorMessage', $any($event.target).value || undefined)"
                  class="form-control"
                  placeholder="Error submitting form. Please try again."
                >
              </div>

              <div class="form-group">
                <label>Redirect URL (on success)</label>
                <input
                  type="text"
                  [value]="schema().submission?.redirectOnSuccess || ''"
                  (input)="updateSubmissionProperty('redirectOnSuccess', $any($event.target).value || undefined)"
                  class="form-control"
                  placeholder="/thank-you"
                >
              </div>

              <div class="form-group">
                <label>
                  <input
                    type="checkbox"
                    [checked]="schema().submission?.showDataOnSuccess || false"
                    (change)="updateSubmissionProperty('showDataOnSuccess', $any($event.target).checked)"
                  >
                  Show data on success
                </label>
              </div>

              <div class="form-group">
                <label>Custom Headers (JSON)</label>
                <textarea
                  [value]="schema().submission?.headers ? JSON.stringify(schema().submission?.headers, null, 2) : ''"
                  (input)="updateSubmissionHeadersJSON($any($event.target).value)"
                  class="form-control"
                  rows="3"
                  placeholder='{"Authorization": "Bearer token", "X-Custom": "value"}'
                ></textarea>
                <small class="text-muted">Optional custom HTTP headers</small>
              </div>
            </div>

            <!-- Autosave Configuration -->
            <div class="settings-group">
              <h4>üíæ Autosave Configuration</h4>

              <div class="form-group">
                <label>
                  <input
                    type="checkbox"
                    [checked]="schema().autosave?.enabled || false"
                    (change)="updateAutosaveProperty('enabled', $any($event.target).checked)"
                  >
                  Enable autosave
                </label>
              </div>

              @if (schema().autosave?.enabled) {
                <div class="form-group">
                  <label>Save Interval (seconds)</label>
                  <input
                    type="number"
                    [value]="schema().autosave?.intervalSeconds || 30"
                    (input)="updateAutosaveProperty('intervalSeconds', Number($any($event.target).value))"
                    class="form-control"
                    min="5"
                    step="5"
                  >
                </div>

                <div class="form-group">
                  <label>Storage Type</label>
                  <select
                    [value]="schema().autosave?.storage || 'localStorage'"
                    (change)="updateAutosaveProperty('storage', $any($event.target).value)"
                    class="form-control"
                  >
                    <option value="localStorage">Local Storage</option>
                    <option value="sessionStorage">Session Storage</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Storage Key</label>
                  <input
                    type="text"
                    [value]="schema().autosave?.key || ''"
                    (input)="updateAutosaveProperty('key', $any($event.target).value || undefined)"
                    class="form-control"
                    placeholder="custom-draft-key"
                  >
                  <small class="text-muted">Leave empty for auto-generated key</small>
                </div>

                <div class="form-group">
                  <label>Expiration (days)</label>
                  <input
                    type="number"
                    [value]="schema().autosave?.expirationDays || 7"
                    (input)="updateAutosaveProperty('expirationDays', Number($any($event.target).value))"
                    class="form-control"
                    min="1"
                  >
                </div>

                <div class="form-group">
                  <label>
                    <input
                      type="checkbox"
                      [checked]="schema().autosave?.showIndicator !== false"
                      (change)="updateAutosaveProperty('showIndicator', $any($event.target).checked)"
                    >
                    Show save indicator
                  </label>
                </div>
              }
            </div>
          </div>
        </section>

        <!-- Field Palette -->
        <section class="palette-section">
          <h3>Field Palette</h3>
          <div class="field-palette">
            @for (template of fieldTemplates; track template.type) {
              <button
                class="palette-item"
                (click)="addField(template)"
                [title]="'Add ' + template.label"
              >
                <span class="palette-icon">{{ template.icon }}</span>
                <span class="palette-label">{{ template.label }}</span>
              </button>
            }
          </div>
        </section>

        <!-- Multi-Step Mode: Sections -->
        @if (multiStepMode()) {
          <section class="tree-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3>Form Sections ({{ currentSections().length }})</h3>
              <button class="btn btn-sm btn-primary" (click)="addSection()" title="Add Section">
                ‚ûï Add Section
              </button>
            </div>

            <div
              class="sections-tree"
              cdkDropList
              (cdkDropListDropped)="onSectionDrop($event)"
            >
              @if (currentSections().length === 0) {
                <div class="empty-state">
                  <p>No sections yet. Click "Add Section" to create one.</p>
                </div>
              } @else {
                @for (section of currentSections(); track $index) {
                  <div class="section-item" cdkDrag [class.selected]="selectedSectionIndex() === $index">
                    <div
                      class="section-header"
                      (click)="selectSection($index)"
                    >
                      <div class="drag-handle" cdkDragHandle>
                        <span class="drag-icon">‚ãÆ‚ãÆ</span>
                      </div>
                      <div class="section-info">
                        <span class="section-icon">{{ section.icon || 'üìã' }}</span>
                        <div class="section-details">
                          <div class="section-title">{{ section.title }}</div>
                          <div class="section-meta">{{ section.fields.length }} fields</div>
                        </div>
                      </div>
                      <div class="section-actions">
                        <button
                          class="btn-icon btn-danger"
                          (click)="removeSection($index); $event.stopPropagation()"
                          title="Delete"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </div>

                    <!-- Fields in this section -->
                    @if (selectedSectionIndex() === $index) {
                      <div class="section-fields">
                        <div class="section-fields-header">
                          <h4>Fields in this section</h4>
                        </div>

                        @if (section.fields.length === 0) {
                          <div class="empty-state-small">
                            <p>No fields yet. Add fields from the palette above.</p>
                          </div>
                        } @else {
                          <div
                            cdkDropList
                            (cdkDropListDropped)="onFieldDrop($event)"
                          >
                            @for (field of section.fields; track $index) {
                              <div
                                class="field-item"
                                cdkDrag
                                [class.selected]="selectedFieldIndex() === $index"
                                (click)="selectField($index)"
                              >
                                <div class="drag-handle" cdkDragHandle>
                                  <span class="drag-icon">‚ãÆ‚ãÆ</span>
                                </div>
                                <div class="field-item-content">
                                  <span class="field-icon">{{ getFieldIcon(field.type) }}</span>
                                  <div class="field-info">
                                    <div class="field-name">{{ field.name }}</div>
                                    <div class="field-label">{{ field.label }}</div>
                                  </div>
                                </div>
                                <div class="field-actions">
                                  <button
                                    class="btn-icon btn-danger"
                                    (click)="removeField($index); $event.stopPropagation()"
                                    title="Delete"
                                  >
                                    üóëÔ∏è
                                  </button>
                                </div>
                                <div class="drag-placeholder" *cdkDragPlaceholder></div>
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                    <div class="drag-placeholder" *cdkDragPlaceholder></div>
                  </div>
                }
              }
            </div>
          </section>
        } @else {
          <!-- Single-Step Mode: Fields -->
          <section class="tree-section">
            <h3>Form Fields ({{ currentFields().length }})</h3>
            <div
              class="field-tree"
              cdkDropList
              (cdkDropListDropped)="onFieldDrop($event)"
            >
              @if (currentFields().length === 0) {
                <div class="empty-state">
                  <p>üëÜ Click a field type above to add it to your form</p>
                </div>
              } @else {
                @for (field of currentFields(); track $index) {
                  <div
                    class="field-item"
                    cdkDrag
                    [class.selected]="selectedFieldIndex() === $index"
                    (click)="selectField($index)"
                  >
                    <div class="drag-handle" cdkDragHandle>
                      <span class="drag-icon">‚ãÆ‚ãÆ</span>
                    </div>
                    <div class="field-item-content">
                      <span class="field-icon">{{ getFieldIcon(field.type) }}</span>
                      <div class="field-info">
                        <div class="field-name">{{ field.name }}</div>
                        <div class="field-label">{{ field.label }}</div>
                      </div>
                    </div>
                    <div class="field-actions">
                      <button
                        class="btn-icon btn-danger"
                        (click)="removeField($index); $event.stopPropagation()"
                        title="Delete"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                    <div class="drag-placeholder" *cdkDragPlaceholder></div>
                  </div>
                }
              }
            </div>
          </section>
        }

        <!-- Section Properties Editor (Multi-Step Mode) -->
        @if (multiStepMode() && selectedSection(); as section) {
          <section class="properties-section">
            <h3>üìã Section Properties</h3>
            <div class="properties-form">
              <div class="form-group">
                <label>Section Title</label>
                <input
                  type="text"
                  [value]="section.title"
                  (input)="updateSectionProperty('title', $any($event.target).value)"
                  class="form-control"
                >
              </div>

              <div class="form-group">
                <label>Description</label>
                <textarea
                  [value]="section.description || ''"
                  (input)="updateSectionProperty('description', $any($event.target).value)"
                  class="form-control"
                  rows="2"
                  placeholder="Optional description for this step"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Icon (emoji or text)</label>
                <input
                  type="text"
                  [value]="section.icon || ''"
                  (input)="updateSectionProperty('icon', $any($event.target).value)"
                  class="form-control"
                  placeholder="e.g., üìã, üë§, üîê"
                >
              </div>
            </div>
          </section>
        }

        <!-- Field Properties Editor -->
        @if (selectedField(); as field) {
          <section class="properties-section">
            <h3>‚öôÔ∏è Field Properties</h3>
            <div class="properties-form">
              <div class="form-group">
                <label>Field Name</label>
                <input
                  type="text"
                  [value]="field.name"
                  (input)="updateFieldProperty('name', $any($event.target).value)"
                  class="form-control"
                >
              </div>

              <div class="form-group">
                <label>Label</label>
                <input
                  type="text"
                  [value]="field.label"
                  (input)="updateFieldProperty('label', $any($event.target).value)"
                  class="form-control"
                >
              </div>

              <div class="form-group">
                <label>Placeholder</label>
                <input
                  type="text"
                  [value]="field.placeholder || ''"
                  (input)="updateFieldProperty('placeholder', $any($event.target).value)"
                  class="form-control"
                >
              </div>

              <div class="form-group">
                <label>
                  <input
                    type="checkbox"
                    [checked]="field.validations?.required || false"
                    (change)="toggleRequired(field, $any($event.target).checked)"
                  >
                  Required
                </label>
              </div>

              <div class="form-group">
                <label>
                  <input
                    type="checkbox"
                    [checked]="field.readonly || false"
                    (change)="updateFieldProperty('readonly', $any($event.target).checked)"
                  >
                  Read Only
                </label>
              </div>

              <div class="form-group">
                <label>
                  <input
                    type="checkbox"
                    [checked]="field.disabled || false"
                    (change)="updateFieldProperty('disabled', $any($event.target).checked)"
                  >
                  Disabled
                </label>
              </div>

              <!-- Dependency & Visibility Section -->
              <div class="advanced-section" style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">
                <h4>üîó Dependencies & Visibility</h4>

                <div class="form-group">
                  <label>Depends On (field name)</label>
                  <input
                    type="text"
                    [value]="Array.isArray(field.dependsOn) ? field.dependsOn.join(', ') : (field.dependsOn || '')"
                    (input)="updateFieldProperty('dependsOn', $any($event.target).value || undefined)"
                    class="form-control"
                    placeholder="e.g., country or country,state"
                  >
                  <small class="text-muted">Comma-separated for multiple dependencies</small>
                </div>

                <div class="form-group">
                  <label>Options Endpoint URL</label>
                  <input
                    type="text"
                    [value]="field.optionsEndpoint || ''"
                    (input)="updateFieldProperty('optionsEndpoint', $any($event.target).value || undefined)"
                    class="form-control"
                    placeholder="https://api.example.com/options"
                  >
                  <small class="text-muted">API endpoint to fetch dynamic options</small>
                </div>

                @if (field.type === 'checkbox' && field.dependsOn) {
                  <div class="form-group">
                    <label>Dependency Type</label>
                    <select
                      [value]="field.dependencyType || 'same'"
                      (change)="updateFieldProperty('dependencyType', $any($event.target).value)"
                      class="form-control"
                    >
                      <option value="same">Same (both checked/unchecked)</option>
                      <option value="opposite">Opposite (inverse)</option>
                    </select>
                  </div>
                }

                <div class="form-group">
                  <label>Visible When (JSON condition)</label>
                  <textarea
                    [value]="field.visibleWhen ? JSON.stringify(field.visibleWhen, null, 2) : ''"
                    (input)="updateFieldPropertyJSON('visibleWhen', $any($event.target).value)"
                    class="form-control"
                    rows="3"
                    placeholder='{"field": "country", "operator": "equals", "value": "US"}'
                  ></textarea>
                  <small class="text-muted">Conditional visibility configuration</small>
                </div>
              </div>

              <!-- Advanced Validations Section -->
              <div class="advanced-section" style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">
                <h4>‚úÖ Advanced Validations</h4>

                <div class="form-group">
                  <label>Min Length</label>
                  <input
                    type="number"
                    [value]="field.validations?.minLength || ''"
                    (input)="updateValidationProperty('minLength', $any($event.target).value ? Number($any($event.target).value) : undefined)"
                    class="form-control"
                    min="0"
                    placeholder="Minimum string length"
                  >
                </div>

                <div class="form-group">
                  <label>Max Length</label>
                  <input
                    type="number"
                    [value]="field.validations?.maxLength || ''"
                    (input)="updateValidationProperty('maxLength', $any($event.target).value ? Number($any($event.target).value) : undefined)"
                    class="form-control"
                    min="1"
                    placeholder="Maximum string length"
                  >
                </div>

                <div class="form-group">
                  <label>Pattern (regex)</label>
                  <input
                    type="text"
                    [value]="field.validations?.pattern || ''"
                    (input)="updateValidationProperty('pattern', $any($event.target).value || undefined)"
                    class="form-control"
                    placeholder="e.g., ^[A-Z][a-z]*$"
                  >
                </div>

                <div class="form-group">
                  <label>Custom Error Message</label>
                  <input
                    type="text"
                    [value]="field.validations?.customMessage || ''"
                    (input)="updateValidationProperty('customMessage', $any($event.target).value || undefined)"
                    class="form-control"
                    placeholder="Custom validation error message"
                  >
                </div>

                <div class="form-group">
                  <label>Matches Field</label>
                  <input
                    type="text"
                    [value]="field.validations?.matchesField || ''"
                    (input)="updateValidationProperty('matchesField', $any($event.target).value || undefined)"
                    class="form-control"
                    placeholder="e.g., password (for confirmation)"
                  >
                </div>

                <div class="form-group">
                  <label>Greater Than Field</label>
                  <input
                    type="text"
                    [value]="field.validations?.greaterThanField || ''"
                    (input)="updateValidationProperty('greaterThanField', $any($event.target).value || undefined)"
                    class="form-control"
                    placeholder="Field name (for date/number comparison)"
                  >
                </div>

                <div class="form-group">
                  <label>Less Than Field</label>
                  <input
                    type="text"
                    [value]="field.validations?.lessThanField || ''"
                    (input)="updateValidationProperty('lessThanField', $any($event.target).value || undefined)"
                    class="form-control"
                    placeholder="Field name (for date/number comparison)"
                  >
                </div>

                @if (field.type === 'checkbox') {
                  <div class="form-group">
                    <label>
                      <input
                        type="checkbox"
                        [checked]="field.validations?.requiredTrue || false"
                        (change)="updateValidationProperty('requiredTrue', $any($event.target).checked ? true : undefined)"
                      >
                      Required True (must be checked)
                    </label>
                  </div>
                }

                <div class="form-group">
                  <label>Async Validator (JSON config)</label>
                  <textarea
                    [value]="field.validations?.asyncValidator ? JSON.stringify(field.validations?.asyncValidator, null, 2) : ''"
                    (input)="updateAsyncValidatorJSON($any($event.target).value)"
                    class="form-control"
                    rows="4"
                    placeholder='{"endpoint": "https://api.example.com/validate", "method": "POST"}'
                  ></textarea>
                  <small class="text-muted">API-based async validation</small>
                </div>
              </div>

              <!-- Layout & Styling Section -->
              <div class="advanced-section" style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">
                <h4>üé® Layout & Styling</h4>

                <div class="form-group">
                  <label>Field Width</label>
                  <select
                    [value]="field.width || 'full'"
                    (change)="updateFieldProperty('width', $any($event.target).value)"
                    class="form-control"
                  >
                    <option value="full">Full Width</option>
                    <option value="half">Half Width</option>
                    <option value="third">Third Width</option>
                    <option value="quarter">Quarter Width</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Custom CSS Class</label>
                  <input
                    type="text"
                    [value]="field.cssClass || ''"
                    (input)="updateFieldProperty('cssClass', $any($event.target).value || undefined)"
                    class="form-control"
                    placeholder="e.g., my-custom-class"
                  >
                </div>

                @if (field.type === 'radio') {
                  <div class="form-group">
                    <label>Layout</label>
                    <select
                      [value]="field.layout || 'vertical'"
                      (change)="updateFieldProperty('layout', $any($event.target).value)"
                      class="form-control"
                    >
                      <option value="vertical">Vertical</option>
                      <option value="horizontal">Horizontal</option>
                    </select>
                  </div>
                }
              </div>

              <!-- Input Masking Section -->
              <div class="advanced-section" style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">
                <h4>üé≠ Input Masking</h4>

                <div class="form-group">
                  <label>Mask Type</label>
                  <select
                    [value]="getMaskValue(field)"
                    (change)="updateFieldProperty('mask', $any($event.target).value || undefined)"
                    class="form-control"
                  >
                    <option value="">None</option>
                    <option value="phone">Phone - (123) 456-7890</option>
                    <option value="phone-intl">Phone Intl - +1 (123) 456-7890</option>
                    <option value="credit-card">Credit Card - 1234 5678 9012 3456</option>
                    <option value="ssn">SSN - 123-45-6789</option>
                    <option value="zip">ZIP - 12345</option>
                    <option value="zip-plus4">ZIP+4 - 12345-6789</option>
                    <option value="currency">Currency - $1,234.56</option>
                    <option value="date-us">Date US - MM/DD/YYYY</option>
                    <option value="time">Time - HH:MM</option>
                  </select>
                </div>
              </div>

              <!-- Computed Field Section -->
              <div class="advanced-section" style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">
                <h4>üßÆ Computed Field</h4>

                <div class="form-group">
                  <label>Formula</label>
                  <input
                    type="text"
                    [value]="field.computed?.formula || ''"
                    (input)="updateComputedProperty('formula', $any($event.target).value || undefined)"
                    class="form-control"
                    placeholder='e.g., price * quantity'
                  >
                  <small class="text-muted">Formula to auto-calculate value</small>
                </div>

                @if (field.computed?.formula) {
                  <div class="form-group">
                    <label>Dependencies (comma-separated)</label>
                    <input
                      type="text"
                      [value]="field.computed?.dependencies?.join(', ') || ''"
                      (input)="updateComputedDependencies($any($event.target).value)"
                      class="form-control"
                      placeholder="e.g., price, quantity"
                    >
                  </div>

                  <div class="form-group">
                    <label>Format As</label>
                    <select
                      [value]="field.computed?.formatAs || 'number'"
                      (change)="updateComputedProperty('formatAs', $any($event.target).value)"
                      class="form-control"
                    >
                      <option value="number">Number</option>
                      <option value="currency">Currency</option>
                      <option value="text">Text</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Decimal Places</label>
                    <input
                      type="number"
                      [value]="field.computed?.decimal || 2"
                      (input)="updateComputedProperty('decimal', Number($any($event.target).value))"
                      class="form-control"
                      min="0"
                      max="10"
                    >
                  </div>

                  <div class="form-group">
                    <label>Prefix</label>
                    <input
                      type="text"
                      [value]="field.computed?.prefix || ''"
                      (input)="updateComputedProperty('prefix', $any($event.target).value || undefined)"
                      class="form-control"
                      placeholder='e.g., $, Total: '
                    >
                  </div>

                  <div class="form-group">
                    <label>Suffix</label>
                    <input
                      type="text"
                      [value]="field.computed?.suffix || ''"
                      (input)="updateComputedProperty('suffix', $any($event.target).value || undefined)"
                      class="form-control"
                      placeholder='e.g., %, kg'
                    >
                  </div>
                }
              </div>

              <!-- Move to Section (Multi-Step Mode) -->
              @if (multiStepMode() && currentSections().length > 1) {
                <div class="form-group">
                  <label>Move to Section</label>
                  <select
                    class="form-control"
                    (change)="moveFieldToSection(selectedFieldIndex()!, Number($any($event.target).value))"
                  >
                    <option value="" disabled selected>-- Select Section --</option>
                    @for (section of currentSections(); track $index) {
                      @if ($index !== selectedSectionIndex()) {
                        <option [value]="$index">{{ section.title }}</option>
                      }
                    }
                  </select>
                </div>
              }

              <!-- Array Field Configuration -->
              @if (field.type === 'array' && field.arrayConfig) {
                <div class="array-config-section">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">üîÅ Array Configuration</h4>

                  <div class="form-group">
                    <label>Minimum Items</label>
                    <input
                      type="number"
                      [value]="field.arrayConfig.minItems || 0"
                      (input)="updateArrayConfig('minItems', Number($any($event.target).value))"
                      class="form-control"
                      min="0"
                    >
                  </div>

                  <div class="form-group">
                    <label>Maximum Items</label>
                    <input
                      type="number"
                      [value]="field.arrayConfig.maxItems || ''"
                      (input)="updateArrayConfig('maxItems', $any($event.target).value ? Number($any($event.target).value) : undefined)"
                      class="form-control"
                      min="1"
                      placeholder="Unlimited"
                    >
                  </div>

                  <div class="form-group">
                    <label>Initial Items</label>
                    <input
                      type="number"
                      [value]="field.arrayConfig.initialItems || 1"
                      (input)="updateArrayConfig('initialItems', Number($any($event.target).value))"
                      class="form-control"
                      min="0"
                    >
                  </div>

                  <div class="form-group">
                    <label>Add Button Text</label>
                    <input
                      type="text"
                      [value]="field.arrayConfig.addButtonText || ''"
                      (input)="updateArrayConfig('addButtonText', $any($event.target).value)"
                      class="form-control"
                      placeholder="Add Item"
                    >
                  </div>

                  <div class="form-group">
                    <label>Remove Button Text</label>
                    <input
                      type="text"
                      [value]="field.arrayConfig.removeButtonText || ''"
                      (input)="updateArrayConfig('removeButtonText', $any($event.target).value)"
                      class="form-control"
                      placeholder="Remove"
                    >
                  </div>

                  <h4 style="margin-top: 1rem;">Sub-Fields</h4>
                  <div class="array-subfields">
                    @for (subField of field.arrayConfig.fields || []; track $index) {
                      <div class="subfield-item" style="border: 1px solid #ddd; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px;">
                        <div class="form-group" style="margin-bottom: 0.5rem;">
                          <label style="font-size: 0.9em;">Type</label>
                          <select
                            [value]="subField.type"
                            (change)="updateArraySubFieldProperty(selectedFieldIndex()!, $index, 'type', $any($event.target).value)"
                            class="form-control"
                          >
                            <option value="text">Text</option>
                            <option value="email">Email</option>
                            <option value="password">Password</option>
                            <option value="number">Number</option>
                            <option value="textarea">Textarea</option>
                            <option value="select">Select</option>
                            <option value="date">Date</option>
                          </select>
                        </div>

                        <div class="form-group" style="margin-bottom: 0.5rem;">
                          <label style="font-size: 0.9em;">Name</label>
                          <input
                            type="text"
                            [value]="subField.name"
                            (input)="updateArraySubFieldProperty(selectedFieldIndex()!, $index, 'name', $any($event.target).value)"
                            class="form-control"
                          >
                        </div>

                        <div class="form-group" style="margin-bottom: 0.5rem;">
                          <label style="font-size: 0.9em;">Label</label>
                          <input
                            type="text"
                            [value]="subField.label"
                            (input)="updateArraySubFieldProperty(selectedFieldIndex()!, $index, 'label', $any($event.target).value)"
                            class="form-control"
                          >
                        </div>

                        <div class="form-group" style="margin-bottom: 0.5rem;">
                          <label style="font-size: 0.9em;">Placeholder</label>
                          <input
                            type="text"
                            [value]="subField.placeholder || ''"
                            (input)="updateArraySubFieldProperty(selectedFieldIndex()!, $index, 'placeholder', $any($event.target).value)"
                            class="form-control"
                          >
                        </div>

                        <button
                          class="btn btn-danger btn-sm"
                          (click)="removeArraySubField(selectedFieldIndex()!, $index)"
                          style="width: 100%; margin-top: 0.5rem;"
                        >
                          üóëÔ∏è Remove Sub-Field
                        </button>
                      </div>
                    }

                    <button
                      class="btn btn-primary"
                      (click)="addArraySubField(selectedFieldIndex()!)"
                      style="width: 100%; margin-top: 0.5rem;"
                    >
                      ‚ûï Add Sub-Field
                    </button>
                  </div>
                </div>
              }

              <!-- Number & Range Field Configuration -->
              @if (field.type === 'number' || field.type === 'range') {
                <div class="type-specific-config">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">{{ field.type === 'range' ? 'üéöÔ∏è' : 'üî¢' }} {{ field.type === 'range' ? 'Range' : 'Number' }} Configuration</h4>

                  <div class="form-group">
                    <label>Minimum Value</label>
                    <input
                      type="number"
                      [value]="field.min || 0"
                      (input)="updateFieldProperty('min', Number($any($event.target).value))"
                      class="form-control"
                    >
                  </div>

                  <div class="form-group">
                    <label>Maximum Value</label>
                    <input
                      type="number"
                      [value]="field.max || 100"
                      (input)="updateFieldProperty('max', Number($any($event.target).value))"
                      class="form-control"
                    >
                  </div>

                  <div class="form-group">
                    <label>Step</label>
                    <input
                      type="number"
                      [value]="field.step || 1"
                      (input)="updateFieldProperty('step', Number($any($event.target).value))"
                      class="form-control"
                      min="0.01"
                      step="0.01"
                    >
                  </div>
                </div>
              }

              <!-- Select & Multi-Select Search Configuration -->
              @if (field.type === 'select' || field.type === 'multiselect') {
                <div class="type-specific-config">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">üîç Search Configuration</h4>

                  <div class="form-group">
                    <label>
                      <input
                        type="checkbox"
                        [checked]="field.searchable || false"
                        (change)="updateFieldProperty('searchable', $any($event.target).checked)"
                      >
                      Enable Search/Filter (useful for large option lists)
                    </label>
                  </div>
                </div>
              }

              <!-- Multi-Select Configuration -->
              @if (field.type === 'multiselect') {
                <div class="type-specific-config">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">‚òëÔ∏è Multi-Select Configuration</h4>

                  <div class="form-group">
                    <label>Minimum Selections</label>
                    <input
                      type="number"
                      [value]="field.minSelections || 0"
                      (input)="updateFieldProperty('minSelections', Number($any($event.target).value))"
                      class="form-control"
                      min="0"
                    >
                  </div>

                  <div class="form-group">
                    <label>Maximum Selections</label>
                    <input
                      type="number"
                      [value]="field.maxSelections || ''"
                      (input)="updateFieldProperty('maxSelections', $any($event.target).value ? Number($any($event.target).value) : undefined)"
                      class="form-control"
                      min="1"
                      placeholder="Unlimited"
                    >
                  </div>
                </div>
              }

              <!-- DateTime Configuration -->
              @if (field.type === 'datetime') {
                <div class="type-specific-config">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">üìÖ DateTime Configuration</h4>

                  <div class="form-group">
                    <label>
                      <input
                        type="checkbox"
                        [checked]="field.includeTime !== false"
                        (change)="updateFieldProperty('includeTime', $any($event.target).checked)"
                      >
                      Include Time
                    </label>
                  </div>

                  <div class="form-group">
                    <label>Timezone</label>
                    <input
                      type="text"
                      [value]="field.timezone || ''"
                      (input)="updateFieldProperty('timezone', $any($event.target).value)"
                      class="form-control"
                      placeholder="e.g., America/New_York"
                    >
                  </div>
                </div>
              }

              <!-- File Upload Configuration -->
              @if (field.type === 'file') {
                <div class="type-specific-config">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">üìé File Upload Configuration</h4>

                  <div class="form-group">
                    <label>Accepted File Types</label>
                    <input
                      type="text"
                      [value]="field.accept || ''"
                      (input)="updateFieldProperty('accept', $any($event.target).value)"
                      class="form-control"
                      placeholder="e.g., image/*, .pdf, .doc"
                    >
                  </div>

                  <div class="form-group">
                    <label>Max File Size (bytes)</label>
                    <input
                      type="number"
                      [value]="field.maxFileSize || 5242880"
                      (input)="updateFieldProperty('maxFileSize', Number($any($event.target).value))"
                      class="form-control"
                    >
                    <small class="text-muted">5MB = 5242880 bytes, 10MB = 10485760 bytes</small>
                  </div>

                  <div class="form-group">
                    <label>
                      <input
                        type="checkbox"
                        [checked]="field.multiple || false"
                        (change)="updateFieldProperty('multiple', $any($event.target).checked)"
                      >
                      Allow Multiple Files
                    </label>
                  </div>
                </div>
              }

              <!-- Rich Text Configuration -->
              @if (field.type === 'richtext') {
                <div class="type-specific-config">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">üìù Rich Text Configuration</h4>

                  <div class="form-group">
                    <label>Maximum Characters</label>
                    <input
                      type="number"
                      [value]="field.maxCharacters || ''"
                      (input)="updateFieldProperty('maxCharacters', $any($event.target).value ? Number($any($event.target).value) : undefined)"
                      class="form-control"
                      min="1"
                      placeholder="Unlimited"
                    >
                  </div>
                </div>
              }

              <!-- DataTable Configuration -->
              @if (field.type === 'datatable' && field.tableConfig) {
                <div class="datatable-config-section">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">üìä DataTable Configuration</h4>

                  <!-- Columns Configuration -->
                  <h5 style="margin-top: 1rem;">Columns</h5>
                  <div class="datatable-columns">
                    @for (column of field.tableConfig.columns || []; track colIdx; let colIdx = $index) {
                      <div class="column-item" style="border: 1px solid #ddd; padding: 0.75rem; margin-bottom: 0.75rem; border-radius: 4px; background-color: #f9f9f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                          <strong style="font-size: 0.95em;">Column {{ colIdx + 1 }}: {{ column.label || 'Untitled' }}</strong>
                          <button
                            class="btn btn-danger btn-sm"
                            (click)="removeTableColumn(selectedFieldIndex()!, colIdx)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.85em;"
                          >
                            üóëÔ∏è
                          </button>
                        </div>

                        <div class="form-group" style="margin-bottom: 0.5rem;">
                          <label style="font-size: 0.9em;">Key (property name)</label>
                          <input
                            type="text"
                            [value]="column.key"
                            (input)="updateTableColumn(selectedFieldIndex()!, colIdx, 'key', $any($event.target).value)"
                            class="form-control"
                            placeholder="id"
                          >
                        </div>

                        <div class="form-group" style="margin-bottom: 0.5rem;">
                          <label style="font-size: 0.9em;">Label</label>
                          <input
                            type="text"
                            [value]="column.label"
                            (input)="updateTableColumn(selectedFieldIndex()!, colIdx, 'label', $any($event.target).value)"
                            class="form-control"
                            placeholder="ID"
                          >
                        </div>

                        <div class="form-group" style="margin-bottom: 0.5rem;">
                          <label style="font-size: 0.9em;">Type</label>
                          <select
                            [value]="column.type || 'text'"
                            (change)="updateTableColumn(selectedFieldIndex()!, colIdx, 'type', $any($event.target).value)"
                            class="form-control"
                          >
                            <option value="text">Text</option>
                            <option value="number">Number</option>
                            <option value="date">Date</option>
                            <option value="currency">Currency</option>
                            <option value="badge">Badge</option>
                            <option value="avatar">Avatar</option>
                            <option value="link">Link</option>
                            <option value="actions">Actions</option>
                          </select>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                          <div class="form-group" style="margin-bottom: 0.5rem;">
                            <label style="font-size: 0.9em;">Width</label>
                            <input
                              type="text"
                              [value]="column.width || ''"
                              (input)="updateTableColumn(selectedFieldIndex()!, colIdx, 'width', $any($event.target).value || undefined)"
                              class="form-control"
                              placeholder="auto"
                            >
                          </div>

                          <div class="form-group" style="margin-bottom: 0.5rem;">
                            <label style="font-size: 0.9em;">Align</label>
                            <select
                              [value]="column.align || 'left'"
                              (change)="updateTableColumn(selectedFieldIndex()!, colIdx, 'align', $any($event.target).value)"
                              class="form-control"
                            >
                              <option value="left">Left</option>
                              <option value="center">Center</option>
                              <option value="right">Right</option>
                            </select>
                          </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                          <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.9em;">
                              <input
                                type="checkbox"
                                [checked]="column.sortable || false"
                                (change)="updateTableColumn(selectedFieldIndex()!, colIdx, 'sortable', $any($event.target).checked)"
                              >
                              Sortable
                            </label>
                          </div>

                          <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.9em;">
                              <input
                                type="checkbox"
                                [checked]="column.filterable || false"
                                (change)="updateTableColumn(selectedFieldIndex()!, colIdx, 'filterable', $any($event.target).checked)"
                              >
                              Filterable
                            </label>
                          </div>
                        </div>

                        @if (column.type === 'badge') {
                          <div class="form-group" style="margin-top: 0.5rem;">
                            <label style="font-size: 0.9em;">Badge Color Map (JSON)</label>
                            <textarea
                              [value]="JSON.stringify(column.badgeColorMap || {}, null, 2)"
                              (input)="updateTableColumnBadgeColorMap(selectedFieldIndex()!, colIdx, $any($event.target).value)"
                              class="form-control"
                              rows="3"
                              placeholder='{"active": "success", "inactive": "secondary"}'
                            ></textarea>
                          </div>
                        }

                        @if (column.type === 'link') {
                          <div class="form-group" style="margin-top: 0.5rem;">
                            <label style="font-size: 0.9em;">Link Template</label>
                            <input
                              type="text"
                              [value]="column.linkTemplate || ''"
                              (input)="updateTableColumn(selectedFieldIndex()!, colIdx, 'linkTemplate', $any($event.target).value)"
                              class="form-control"
                              [attr.placeholder]="'/users/' + '{{' + 'id' + '}}'"
                            >
                          </div>
                          <div class="form-group" style="margin-top: 0.5rem;">
                            <label style="font-size: 0.9em;">Link Target</label>
                            <select
                              [value]="column.linkTarget || '_self'"
                              (change)="updateTableColumn(selectedFieldIndex()!, colIdx, 'linkTarget', $any($event.target).value)"
                              class="form-control"
                            >
                              <option value="_self">Same Window</option>
                              <option value="_blank">New Tab</option>
                            </select>
                          </div>
                        }

                        @if (column.type === 'actions') {
                          <div class="actions-config" style="margin-top: 0.5rem; border-top: 1px solid #ccc; padding-top: 0.75rem;">
                            <h5 style="font-size: 0.95em; margin-bottom: 0.5rem;">‚ö° Action Buttons</h5>

                            @for (action of column.actions || []; track actionIdx; let actionIdx = $index) {
                              <div style="background: white; border: 1px solid #ddd; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                  <strong style="font-size: 0.85em;">{{ action.label || 'Action ' + (actionIdx + 1) }}</strong>
                                  <button
                                    class="btn btn-danger btn-sm"
                                    (click)="removeTableColumnAction(selectedFieldIndex()!, colIdx, actionIdx)"
                                    style="padding: 0.15rem 0.4rem; font-size: 0.75em;"
                                  >
                                    ‚úï
                                  </button>
                                </div>

                                <div class="form-group" style="margin-bottom: 0.4rem;">
                                  <label style="font-size: 0.85em;">Label</label>
                                  <input
                                    type="text"
                                    [value]="action.label"
                                    (input)="updateTableColumnAction(selectedFieldIndex()!, colIdx, actionIdx, 'label', $any($event.target).value)"
                                    class="form-control form-control-sm"
                                    placeholder="Edit"
                                  >
                                </div>

                                <div class="form-group" style="margin-bottom: 0.4rem;">
                                  <label style="font-size: 0.85em;">Icon/Emoji</label>
                                  <input
                                    type="text"
                                    [value]="action.icon || ''"
                                    (input)="updateTableColumnAction(selectedFieldIndex()!, colIdx, actionIdx, 'icon', $any($event.target).value || undefined)"
                                    class="form-control form-control-sm"
                                    placeholder="‚úèÔ∏è"
                                  >
                                </div>

                                <div class="form-group" style="margin-bottom: 0.4rem;">
                                  <label style="font-size: 0.85em;">Type</label>
                                  <select
                                    [value]="action.type || 'button'"
                                    (change)="updateTableColumnAction(selectedFieldIndex()!, colIdx, actionIdx, 'type', $any($event.target).value)"
                                    class="form-control form-control-sm"
                                  >
                                    <option value="button">Button</option>
                                    <option value="menu">Dropdown Menu</option>
                                  </select>
                                </div>

                                <div class="form-group" style="margin-bottom: 0.4rem;">
                                  <label style="font-size: 0.85em;">Color</label>
                                  <select
                                    [value]="action.color || 'secondary'"
                                    (change)="updateTableColumnAction(selectedFieldIndex()!, colIdx, actionIdx, 'color', $any($event.target).value)"
                                    class="form-control form-control-sm"
                                  >
                                    <option value="primary">Primary (Blue)</option>
                                    <option value="secondary">Secondary (Gray)</option>
                                    <option value="danger">Danger (Red)</option>
                                    <option value="warning">Warning (Yellow)</option>
                                  </select>
                                </div>

                                <div class="form-group" style="margin-bottom: 0.4rem;">
                                  <label style="font-size: 0.85em;">onClick Handler</label>
                                  <input
                                    type="text"
                                    [value]="action.onClick || ''"
                                    (input)="updateTableColumnAction(selectedFieldIndex()!, colIdx, actionIdx, 'onClick', $any($event.target).value || undefined)"
                                    class="form-control form-control-sm"
                                    placeholder="editUser"
                                  >
                                </div>

                                <div class="form-group" style="margin-bottom: 0.4rem;">
                                  <label style="font-size: 0.85em;">Visible When (JS condition)</label>
                                  <input
                                    type="text"
                                    [value]="action.visibleWhen || ''"
                                    (input)="updateTableColumnAction(selectedFieldIndex()!, colIdx, actionIdx, 'visibleWhen', $any($event.target).value || undefined)"
                                    class="form-control form-control-sm"
                                    placeholder="row.status === 'Active'"
                                  >
                                  <small style="color: #666; font-size: 0.75em;">Example: row.status === 'Active' or row.role === 'Admin'</small>
                                </div>

                                @if (action.type === 'menu') {
                                  <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed #ccc;">
                                    <h6 style="font-size: 0.85em; margin-bottom: 0.4rem;">Menu Items</h6>

                                    @for (menuItem of action.menuItems || []; track menuIdx; let menuIdx = $index) {
                                      <div style="background: #f5f5f5; border: 1px solid #ddd; padding: 0.4rem; margin-bottom: 0.4rem; border-radius: 3px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                                          <strong style="font-size: 0.8em;">{{ menuItem.label || 'Item ' + (menuIdx + 1) }}</strong>
                                          <button
                                            class="btn btn-danger btn-sm"
                                            (click)="removeTableColumnActionMenuItem(selectedFieldIndex()!, colIdx, actionIdx, menuIdx)"
                                            style="padding: 0.1rem 0.3rem; font-size: 0.7em;"
                                          >
                                            ‚úï
                                          </button>
                                        </div>

                                        <div class="form-group" style="margin-bottom: 0.3rem;">
                                          <label style="font-size: 0.8em;">Label</label>
                                          <input
                                            type="text"
                                            [value]="menuItem.label"
                                            (input)="updateTableColumnActionMenuItem(selectedFieldIndex()!, colIdx, actionIdx, menuIdx, 'label', $any($event.target).value)"
                                            class="form-control form-control-sm"
                                            placeholder="View Details"
                                          >
                                        </div>

                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem;">
                                          <div class="form-group" style="margin-bottom: 0.3rem;">
                                            <label style="font-size: 0.8em;">Icon</label>
                                            <input
                                              type="text"
                                              [value]="menuItem.icon || ''"
                                              (input)="updateTableColumnActionMenuItem(selectedFieldIndex()!, colIdx, actionIdx, menuIdx, 'icon', $any($event.target).value || undefined)"
                                              class="form-control form-control-sm"
                                              placeholder="üëÅÔ∏è"
                                            >
                                          </div>

                                          <div class="form-group" style="margin-bottom: 0.3rem;">
                                            <label style="font-size: 0.8em;">onClick</label>
                                            <input
                                              type="text"
                                              [value]="menuItem.onClick || ''"
                                              (input)="updateTableColumnActionMenuItem(selectedFieldIndex()!, colIdx, actionIdx, menuIdx, 'onClick', $any($event.target).value || undefined)"
                                              class="form-control form-control-sm"
                                              placeholder="viewDetails"
                                            >
                                          </div>
                                        </div>

                                        <div class="form-group" style="margin-bottom: 0;">
                                          <label style="font-size: 0.8em;">Visible When</label>
                                          <input
                                            type="text"
                                            [value]="menuItem.visibleWhen || ''"
                                            (input)="updateTableColumnActionMenuItem(selectedFieldIndex()!, colIdx, actionIdx, menuIdx, 'visibleWhen', $any($event.target).value || undefined)"
                                            class="form-control form-control-sm"
                                            placeholder="row.hasDetails === true"
                                          >
                                        </div>
                                      </div>
                                    }

                                    <button
                                      class="btn btn-secondary btn-sm"
                                      (click)="addTableColumnActionMenuItem(selectedFieldIndex()!, colIdx, actionIdx)"
                                      style="width: 100%; padding: 0.3rem; font-size: 0.8em;"
                                    >
                                      ‚ûï Add Menu Item
                                    </button>
                                  </div>
                                }
                              </div>
                            }

                            <button
                              class="btn btn-secondary btn-sm"
                              (click)="addTableColumnAction(selectedFieldIndex()!, colIdx)"
                              style="width: 100%; margin-top: 0.3rem; font-size: 0.85em;"
                            >
                              ‚ûï Add Action Button
                            </button>
                          </div>
                        }
                      </div>
                    }

                    <button
                      class="btn btn-primary"
                      (click)="addTableColumn(selectedFieldIndex()!)"
                      style="width: 100%; margin-top: 0.5rem;"
                    >
                      ‚ûï Add Column
                    </button>
                  </div>

                  <!-- Data Source -->
                  <h5 style="margin-top: 1.5rem;">Data Source</h5>
                  <div class="form-group">
                    <label>Data Endpoint (API URL for dynamic data)</label>
                    <input
                      type="text"
                      [value]="field.tableConfig.dataEndpoint || ''"
                      (input)="updateTableConfig('dataEndpoint', $any($event.target).value || undefined)"
                      class="form-control"
                      placeholder="https://api.example.com/data"
                    >
                    <small style="color: #666; font-size: 0.85em;">Leave empty to use static rows data</small>
                  </div>

                  <!-- Pagination Settings -->
                  <h5 style="margin-top: 1.5rem;">Pagination</h5>
                  <div class="form-group">
                    <label>
                      <input
                        type="checkbox"
                        [checked]="field.tableConfig.pagination?.enabled ?? true"
                        (change)="updateTableConfigNested('pagination', 'enabled', $any($event.target).checked)"
                      >
                      Enable Pagination
                    </label>
                  </div>

                  @if (field.tableConfig.pagination?.enabled ?? true) {
                    <div class="form-group">
                      <label>Rows Per Page</label>
                      <input
                        type="number"
                        [value]="field.tableConfig.pagination?.rowsPerPage || 10"
                        (input)="updateTableConfigNested('pagination', 'rowsPerPage', Number($any($event.target).value))"
                        class="form-control"
                        min="1"
                      >
                    </div>

                    <div class="form-group">
                      <label>Rows Per Page Options (comma-separated)</label>
                      <input
                        type="text"
                        [value]="(field.tableConfig.pagination?.rowsPerPageOptions || [10, 25, 50, 100]).join(', ')"
                        (input)="updateTableConfigRowsPerPageOptions(selectedFieldIndex()!, $any($event.target).value)"
                        class="form-control"
                        placeholder="10, 25, 50, 100"
                      >
                    </div>

                    <div class="form-group">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="field.tableConfig.pagination?.showPageInfo ?? true"
                          (change)="updateTableConfigNested('pagination', 'showPageInfo', $any($event.target).checked)"
                        >
                        Show Page Info (e.g., "1-10 of 100")
                      </label>
                    </div>
                  }

                  <!-- Filter Settings -->
                  <h5 style="margin-top: 1.5rem;">Search & Filter</h5>
                  <div class="form-group">
                    <label>
                      <input
                        type="checkbox"
                        [checked]="field.tableConfig.filter?.enabled ?? true"
                        (change)="updateTableConfigNested('filter', 'enabled', $any($event.target).checked)"
                      >
                      Enable Global Search
                    </label>
                  </div>

                  @if (field.tableConfig.filter?.enabled ?? true) {
                    <div class="form-group">
                      <label>Search Placeholder</label>
                      <input
                        type="text"
                        [value]="field.tableConfig.filter?.placeholder || 'Search...'"
                        (input)="updateTableConfigNested('filter', 'placeholder', $any($event.target).value)"
                        class="form-control"
                        placeholder="Search..."
                      >
                    </div>

                    <div class="form-group">
                      <label>Debounce (ms)</label>
                      <input
                        type="number"
                        [value]="field.tableConfig.filter?.debounceMs || 300"
                        (input)="updateTableConfigNested('filter', 'debounceMs', Number($any($event.target).value))"
                        class="form-control"
                        min="0"
                      >
                    </div>
                  }

                  <!-- Selection Settings -->
                  <h5 style="margin-top: 1.5rem;">Row Selection</h5>
                  <div class="form-group">
                    <label>
                      <input
                        type="checkbox"
                        [checked]="field.tableConfig.selection?.enabled || false"
                        (change)="updateTableConfigNested('selection', 'enabled', $any($event.target).checked)"
                      >
                      Enable Row Selection
                    </label>
                  </div>

                  @if (field.tableConfig.selection?.enabled) {
                    <div class="form-group">
                      <label>Selection Mode</label>
                      <select
                        [value]="field.tableConfig.selection?.mode || 'multiple'"
                        (change)="updateTableConfigNested('selection', 'mode', $any($event.target).value)"
                        class="form-control"
                      >
                        <option value="single">Single</option>
                        <option value="multiple">Multiple</option>
                      </select>
                    </div>

                    @if (field.tableConfig.selection?.mode === 'multiple' || !field.tableConfig.selection?.mode) {
                      <div class="form-group">
                        <label>
                          <input
                            type="checkbox"
                            [checked]="field.tableConfig.selection?.showSelectAll ?? true"
                            (change)="updateTableConfigNested('selection', 'showSelectAll', $any($event.target).checked)"
                          >
                          Show Select All Checkbox
                        </label>
                      </div>
                    }
                  }

                  <!-- Styling Options -->
                  <h5 style="margin-top: 1.5rem;">Styling</h5>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div class="form-group">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="field.tableConfig.striped || false"
                          (change)="updateTableConfig('striped', $any($event.target).checked)"
                        >
                        Striped Rows
                      </label>
                    </div>

                    <div class="form-group">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="field.tableConfig.bordered ?? true"
                          (change)="updateTableConfig('bordered', $any($event.target).checked)"
                        >
                        Bordered
                      </label>
                    </div>

                    <div class="form-group">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="field.tableConfig.hoverable || false"
                          (change)="updateTableConfig('hoverable', $any($event.target).checked)"
                        >
                        Hoverable Rows
                      </label>
                    </div>

                    <div class="form-group">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="field.tableConfig.dense || false"
                          (change)="updateTableConfig('dense', $any($event.target).checked)"
                        >
                        Compact/Dense
                      </label>
                    </div>
                  </div>

                  <!-- Other Options -->
                  <h5 style="margin-top: 1.5rem;">Other Options</h5>
                  <div class="form-group">
                    <label>Empty Message</label>
                    <input
                      type="text"
                      [value]="field.tableConfig.emptyMessage || 'No data available'"
                      (input)="updateTableConfig('emptyMessage', $any($event.target).value)"
                      class="form-control"
                      placeholder="No data available"
                    >
                  </div>
                </div>
              }

              <!-- Timeline Configuration -->
              @if (field.type === 'timeline' && field.timelineConfig) {
                <div class="timeline-config-section config-section">
                  <h4>üìÖ Timeline Configuration</h4>

                  <!-- Timeline Items -->
                  <div class="config-subsection">
                    <h5>Timeline Items</h5>
                    @for (item of field.timelineConfig.items || []; track itemIdx; let itemIdx = $index) {
                      <div class="timeline-item-editor">
                        <div class="item-header">
                          <span class="item-number">Item {{ itemIdx + 1 }}</span>
                          <button
                            type="button"
                            class="btn btn-danger btn-sm"
                            (click)="removeTimelineItem(selectedFieldIndex()!, itemIdx)"
                            style="width: 100%; margin-top: 0.5rem;"
                          >
                            üóëÔ∏è Remove Timeline Item
                          </button>
                        </div>

                        <div class="form-group">
                          <label>Title</label>
                          <input
                            type="text"
                            [value]="item.title"
                            (input)="updateTimelineItem(selectedFieldIndex()!, itemIdx, 'title', $any($event.target).value)"
                            class="form-control"
                            placeholder="Item title"
                          >
                        </div>

                        <div class="form-group">
                          <label>Description</label>
                          <textarea
                            [value]="item.description || ''"
                            (input)="updateTimelineItem(selectedFieldIndex()!, itemIdx, 'description', $any($event.target).value)"
                            class="form-control"
                            rows="2"
                            placeholder="Item description"
                          ></textarea>
                        </div>

                        <div class="form-group">
                          <label>Timestamp</label>
                          <input
                            type="datetime-local"
                            [value]="item.timestamp"
                            (input)="updateTimelineItem(selectedFieldIndex()!, itemIdx, 'timestamp', $any($event.target).value)"
                            class="form-control"
                          >
                        </div>

                        <div class="form-row">
                          <div class="form-group">
                            <label>Icon</label>
                            <input
                              type="text"
                              [value]="item.icon || ''"
                              (input)="updateTimelineItem(selectedFieldIndex()!, itemIdx, 'icon', $any($event.target).value)"
                              class="form-control"
                              placeholder="üìå"
                            >
                          </div>

                          <div class="form-group">
                            <label>Status</label>
                            <select
                              [value]="item.status || 'pending'"
                              (change)="updateTimelineItem(selectedFieldIndex()!, itemIdx, 'status', $any($event.target).value)"
                              class="form-control"
                            >
                              <option value="completed">Completed</option>
                              <option value="in-progress">In Progress</option>
                              <option value="pending">Pending</option>
                              <option value="cancelled">Cancelled</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    }

                    <button
                      type="button"
                      class="btn btn-primary"
                      (click)="addTimelineItem(selectedFieldIndex()!)"
                      style="width: 100%; margin-top: 0.5rem;"
                    >
                      ‚ûï Add Timeline Item
                    </button>
                  </div>

                  <!-- Style Configuration -->
                  <div class="config-subsection">
                    <h5>Style Options</h5>

                    <div class="form-row">
                      <div class="form-group">
                        <label>Layout</label>
                        <select
                          [value]="field.timelineConfig.style?.layout || 'vertical'"
                          (change)="updateTimelineStyle('layout', $any($event.target).value)"
                          class="form-control"
                        >
                          <option value="vertical">Vertical</option>
                          <option value="horizontal">Horizontal</option>
                        </select>
                      </div>

                      <div class="form-group">
                        <label>Alignment</label>
                        <select
                          [value]="field.timelineConfig.style?.alignment || 'left'"
                          (change)="updateTimelineStyle('alignment', $any($event.target).value)"
                          class="form-control"
                        >
                          <option value="left">Left</option>
                          <option value="center">Center</option>
                          <option value="right">Right</option>
                          <option value="alternating">Alternating</option>
                        </select>
                      </div>
                    </div>

                    <div class="form-row">
                      <div class="form-group">
                        <label>Marker Style</label>
                        <select
                          [value]="field.timelineConfig.style?.markerStyle || 'dot'"
                          (change)="updateTimelineStyle('markerStyle', $any($event.target).value)"
                          class="form-control"
                        >
                          <option value="dot">Dot</option>
                          <option value="icon">Icon</option>
                          <option value="number">Number</option>
                          <option value="none">None</option>
                        </select>
                      </div>

                      <div class="form-group">
                        <label>Line Style</label>
                        <select
                          [value]="field.timelineConfig.style?.lineStyle || 'solid'"
                          (change)="updateTimelineStyle('lineStyle', $any($event.target).value)"
                          class="form-control"
                        >
                          <option value="solid">Solid</option>
                          <option value="dashed">Dashed</option>
                          <option value="dotted">Dotted</option>
                          <option value="none">None</option>
                        </select>
                      </div>
                    </div>

                    <div class="form-group checkbox-group">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="field.timelineConfig.style?.cardStyle || false"
                          (change)="updateTimelineStyle('cardStyle', $any($event.target).checked)"
                        >
                        Card Style
                      </label>
                    </div>

                    <div class="form-group checkbox-group">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="field.timelineConfig.style?.dense || false"
                          (change)="updateTimelineStyle('dense', $any($event.target).checked)"
                        >
                        Dense Layout
                      </label>
                    </div>

                    <div class="form-group checkbox-group">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="field.timelineConfig.style?.animated || false"
                          (change)="updateTimelineStyle('animated', $any($event.target).checked)"
                        >
                        Animated
                      </label>
                    </div>
                  </div>

                  <!-- Interaction Configuration -->
                  <div class="config-subsection">
                    <h5>Interaction Options</h5>

                    <div class="form-group checkbox-group">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="field.timelineConfig.interaction?.clickable || false"
                          (change)="updateTimelineInteraction('clickable', $any($event.target).checked)"
                        >
                        Clickable
                      </label>
                    </div>

                    <div class="form-group checkbox-group">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="field.timelineConfig.interaction?.expandable || false"
                          (change)="updateTimelineInteraction('expandable', $any($event.target).checked)"
                        >
                        Expandable
                      </label>
                    </div>

                    <div class="form-group checkbox-group">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="field.timelineConfig.interaction?.hoverable || false"
                          (change)="updateTimelineInteraction('hoverable', $any($event.target).checked)"
                        >
                        Hoverable
                      </label>
                    </div>

                    @if (field.timelineConfig.interaction?.clickable) {
                      <div class="form-group">
                        <label>On Item Click (function name)</label>
                        <input
                          type="text"
                          [value]="field.timelineConfig.interaction?.onItemClick || ''"
                          (input)="updateTimelineInteraction('onItemClick', $any($event.target).value)"
                          class="form-control"
                          placeholder="handleItemClick"
                        >
                      </div>
                    }

                    @if (field.timelineConfig.interaction?.expandable) {
                      <div class="form-group">
                        <label>On Item Expand (function name)</label>
                        <input
                          type="text"
                          [value]="field.timelineConfig.interaction?.onItemExpand || ''"
                          (input)="updateTimelineInteraction('onItemExpand', $any($event.target).value)"
                          class="form-control"
                          placeholder="handleItemExpand"
                        >
                      </div>
                    }
                  </div>

                  <!-- Other Options -->
                  <div class="config-subsection">
                    <h5>Other Options</h5>

                    <div class="form-group">
                      <label>Date Format</label>
                      <input
                        type="text"
                        [value]="field.timelineConfig.dateFormat || 'MMM d, yyyy'"
                        (input)="updateTimelineConfig('dateFormat', $any($event.target).value)"
                        class="form-control"
                        placeholder="MMM d, yyyy"
                      >
                    </div>

                    <div class="form-group">
                      <label>Empty Message</label>
                      <input
                        type="text"
                        [value]="field.timelineConfig.emptyMessage || 'No timeline items'"
                        (input)="updateTimelineConfig('emptyMessage', $any($event.target).value)"
                        class="form-control"
                        placeholder="No timeline items"
                      >
                    </div>

                    <div class="form-group checkbox-group">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="field.timelineConfig.showConnector !== false"
                          (change)="updateTimelineConfig('showConnector', $any($event.target).checked)"
                        >
                        Show Connector Line
                      </label>
                    </div>

                    <div class="form-group">
                      <label>Max Items</label>
                      <input
                        type="number"
                        [value]="field.timelineConfig.maxItems || ''"
                        (input)="updateTimelineConfig('maxItems', $any($event.target).value ? Number($any($event.target).value) : undefined)"
                        class="form-control"
                        placeholder="No limit"
                      >
                    </div>

                    <div class="form-group">
                      <label>Sort Order</label>
                      <select
                        [value]="field.timelineConfig.sortOrder || 'desc'"
                        (change)="updateTimelineConfig('sortOrder', $any($event.target).value)"
                        class="form-control"
                      >
                        <option value="asc">Ascending (oldest first)</option>
                        <option value="desc">Descending (newest first)</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label>Data Endpoint</label>
                      <input
                        type="text"
                        [value]="field.timelineConfig.dataEndpoint || ''"
                        (input)="updateTimelineConfig('dataEndpoint', $any($event.target).value)"
                        class="form-control"
                        placeholder="/api/timeline"
                      >
                      <small class="form-text">API endpoint to fetch timeline items dynamically</small>
                    </div>
                  </div>
                </div>
              }
            </div>
          </section>
        }
      </div>
    </div>

    <!-- Panel 2: Live Preview -->
    <div class="panel live-preview">
      <div class="panel-header">
        <h2>üëÅÔ∏è Live Preview</h2>
      </div>

      <div class="panel-body">
        <div class="preview-container">
          @if (multiStepMode() && (!schema().sections || schema().sections?.length === 0)) {
            <div class="empty-state">
              <h3>No sections yet</h3>
              <p>Add sections to see the multi-step form preview</p>
            </div>
          } @else if (!multiStepMode() && (!schema().fields || schema().fields?.length === 0)) {
            <div class="empty-state">
              <h3>No fields yet</h3>
              <p>Add fields from the palette to see them here</p>
            </div>
          } @else {
            <dq-dynamic-form [formSchema]="schema()"></dq-dynamic-form>
          }
        </div>
      </div>
    </div>

    <!-- Panel 3: JSON Editor & Validation -->
    <div class="panel json-editor">
      <div class="panel-header">
        <h2>üíª JSON Schema</h2>
      </div>

      <div class="panel-body">
        <!-- JSON Editor -->
        <section class="json-section">
          <textarea
            class="json-textarea"
            [value]="jsonContent()"
            (input)="jsonContent.set($any($event.target).value); onJsonChange()"
            spellcheck="false"
          ></textarea>
        </section>

        <!-- Validation Results -->
        <section class="validation-section">
          <h3>
            @if (validationResult()?.isValid) {
              ‚úÖ Valid Schema
            } @else {
              ‚ùå Validation Issues
            }
          </h3>

          @if (validationResult(); as result) {
            <!-- Summary -->
            <div class="validation-summary">
              <div class="summary-item">
                <strong>Total Fields:</strong> {{ result.summary.totalFields }}
              </div>
              <div class="summary-item">
                <strong>Required:</strong> {{ result.summary.requiredFields }}
              </div>
              <div class="summary-item">
                <strong>Errors:</strong> <span [class.error]="result.summary.errorCount > 0">{{ result.summary.errorCount }}</span>
              </div>
              <div class="summary-item">
                <strong>Warnings:</strong> <span [class.warning]="result.summary.warningCount > 0">{{ result.summary.warningCount }}</span>
              </div>
            </div>

            <!-- Errors -->
            @if (result.errors.length > 0) {
              <div class="validation-errors">
                <h4>‚ùå Errors</h4>
                <ul>
                  @for (error of result.errors; track $index) {
                    <li class="error-item">{{ error }}</li>
                  }
                </ul>
              </div>
            }

            <!-- Warnings -->
            @if (result.warnings.length > 0) {
              <div class="validation-warnings">
                <h4>‚ö†Ô∏è Warnings</h4>
                <ul>
                  @for (warning of result.warnings; track $index) {
                    <li class="warning-item">{{ warning }}</li>
                  }
                </ul>
              </div>
            }

            <!-- Field Types -->
            @if (result.summary.fieldTypes && getFieldTypesEntries(result.summary.fieldTypes).length > 0) {
              <div class="field-types">
                <h4>üìä Field Types</h4>
                <ul>
                  @for (entry of getFieldTypesEntries(result.summary.fieldTypes); track entry[0]) {
                    <li>{{ entry[0] }}: {{ entry[1] }}</li>
                  }
                </ul>
              </div>
            }
          }
        </section>
      </div>
    </div>
  </div>
</div>
