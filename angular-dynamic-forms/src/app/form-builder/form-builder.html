<div class="form-builder">
  <!-- Header -->
  <header class="builder-header">
    <h1>üõ†Ô∏è Dynamic Form Builder</h1>
    <div class="header-actions">
      <label class="toggle-label">
        <input
          type="checkbox"
          [checked]="multiStepMode()"
          (change)="toggleMultiStepMode()"
        >
        <span>üìã Multi-Step Mode</span>
      </label>
      <button class="btn btn-secondary" (click)="clearForm()">üóëÔ∏è Clear</button>
      <button class="btn btn-secondary" (click)="fileInput.click()">üì• Import</button>
      <button class="btn btn-secondary" (click)="exportSchema()">üì§ Export</button>
      <button class="btn btn-primary" (click)="generateTypeScript()">‚ö° Generate TS</button>
      <input #fileInput type="file" accept=".json" (change)="importSchema($event)" style="display: none">
    </div>
  </header>

  <!-- Three-panel layout -->
  <div class="builder-content">
    <!-- Panel 1: Visual Editor (Field Palette & Tree) -->
    <div class="panel visual-editor">
      <div class="panel-header">
        <h2>üìã Visual Editor</h2>
      </div>

      <div class="panel-body">
        <!-- Field Palette -->
        <section class="palette-section">
          <h3>Field Palette</h3>
          <div class="field-palette">
            @for (template of fieldTemplates; track template.type) {
              <button
                class="palette-item"
                (click)="addField(template)"
                [title]="'Add ' + template.label"
              >
                <span class="palette-icon">{{ template.icon }}</span>
                <span class="palette-label">{{ template.label }}</span>
              </button>
            }
          </div>
        </section>

        <!-- Multi-Step Mode: Sections -->
        @if (multiStepMode()) {
          <section class="tree-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3>Form Sections ({{ currentSections().length }})</h3>
              <button class="btn btn-sm btn-primary" (click)="addSection()" title="Add Section">
                ‚ûï Add Section
              </button>
            </div>

            <div class="sections-tree">
              @if (currentSections().length === 0) {
                <div class="empty-state">
                  <p>No sections yet. Click "Add Section" to create one.</p>
                </div>
              } @else {
                @for (section of currentSections(); track $index) {
                  <div class="section-item" [class.selected]="selectedSectionIndex() === $index">
                    <div
                      class="section-header"
                      (click)="selectSection($index)"
                    >
                      <div class="section-info">
                        <span class="section-icon">{{ section.icon || 'üìã' }}</span>
                        <div class="section-details">
                          <div class="section-title">{{ section.title }}</div>
                          <div class="section-meta">{{ section.fields.length }} fields</div>
                        </div>
                      </div>
                      <div class="section-actions">
                        <button
                          class="btn-icon"
                          (click)="moveSectionUp($index); $event.stopPropagation()"
                          [disabled]="$index === 0"
                          title="Move up"
                        >
                          ‚¨ÜÔ∏è
                        </button>
                        <button
                          class="btn-icon"
                          (click)="moveSectionDown($index); $event.stopPropagation()"
                          [disabled]="$index === currentSections().length - 1"
                          title="Move down"
                        >
                          ‚¨áÔ∏è
                        </button>
                        <button
                          class="btn-icon btn-danger"
                          (click)="removeSection($index); $event.stopPropagation()"
                          title="Delete"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </div>

                    <!-- Fields in this section -->
                    @if (selectedSectionIndex() === $index) {
                      <div class="section-fields">
                        <div class="section-fields-header">
                          <h4>Fields in this section</h4>
                        </div>

                        @if (section.fields.length === 0) {
                          <div class="empty-state-small">
                            <p>No fields yet. Add fields from the palette above.</p>
                          </div>
                        } @else {
                          @for (field of section.fields; track $index) {
                            <div
                              class="field-item"
                              [class.selected]="selectedFieldIndex() === $index"
                              (click)="selectField($index)"
                            >
                              <div class="field-item-content">
                                <span class="field-icon">{{ getFieldIcon(field.type) }}</span>
                                <div class="field-info">
                                  <div class="field-name">{{ field.name }}</div>
                                  <div class="field-label">{{ field.label }}</div>
                                </div>
                              </div>
                              <div class="field-actions">
                                <button
                                  class="btn-icon"
                                  (click)="moveFieldUp($index); $event.stopPropagation()"
                                  [disabled]="$index === 0"
                                  title="Move up"
                                >
                                  ‚¨ÜÔ∏è
                                </button>
                                <button
                                  class="btn-icon"
                                  (click)="moveFieldDown($index); $event.stopPropagation()"
                                  [disabled]="$index === section.fields.length - 1"
                                  title="Move down"
                                >
                                  ‚¨áÔ∏è
                                </button>
                                <button
                                  class="btn-icon btn-danger"
                                  (click)="removeField($index); $event.stopPropagation()"
                                  title="Delete"
                                >
                                  üóëÔ∏è
                                </button>
                              </div>
                            </div>
                          }
                        }
                      </div>
                    }
                  </div>
                }
              }
            </div>
          </section>
        } @else {
          <!-- Single-Step Mode: Fields -->
          <section class="tree-section">
            <h3>Form Fields ({{ currentFields().length }})</h3>
            <div class="field-tree">
              @if (currentFields().length === 0) {
                <div class="empty-state">
                  <p>üëÜ Click a field type above to add it to your form</p>
                </div>
              } @else {
                @for (field of currentFields(); track $index) {
                  <div
                    class="field-item"
                    [class.selected]="selectedFieldIndex() === $index"
                    (click)="selectField($index)"
                  >
                    <div class="field-item-content">
                      <span class="field-icon">{{ getFieldIcon(field.type) }}</span>
                      <div class="field-info">
                        <div class="field-name">{{ field.name }}</div>
                        <div class="field-label">{{ field.label }}</div>
                      </div>
                    </div>
                    <div class="field-actions">
                      <button
                        class="btn-icon"
                        (click)="moveFieldUp($index); $event.stopPropagation()"
                        [disabled]="$index === 0"
                        title="Move up"
                      >
                        ‚¨ÜÔ∏è
                      </button>
                      <button
                        class="btn-icon"
                        (click)="moveFieldDown($index); $event.stopPropagation()"
                        [disabled]="$index === currentFields().length - 1"
                        title="Move down"
                      >
                        ‚¨áÔ∏è
                      </button>
                      <button
                        class="btn-icon btn-danger"
                        (click)="removeField($index); $event.stopPropagation()"
                        title="Delete"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                }
              }
            </div>
          </section>
        }

        <!-- Section Properties Editor (Multi-Step Mode) -->
        @if (multiStepMode() && selectedSection(); as section) {
          <section class="properties-section">
            <h3>üìã Section Properties</h3>
            <div class="properties-form">
              <div class="form-group">
                <label>Section Title</label>
                <input
                  type="text"
                  [value]="section.title"
                  (input)="updateSectionProperty('title', $any($event.target).value)"
                  class="form-control"
                >
              </div>

              <div class="form-group">
                <label>Description</label>
                <textarea
                  [value]="section.description || ''"
                  (input)="updateSectionProperty('description', $any($event.target).value)"
                  class="form-control"
                  rows="2"
                  placeholder="Optional description for this step"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Icon (emoji or text)</label>
                <input
                  type="text"
                  [value]="section.icon || ''"
                  (input)="updateSectionProperty('icon', $any($event.target).value)"
                  class="form-control"
                  placeholder="e.g., üìã, üë§, üîê"
                >
              </div>
            </div>
          </section>
        }

        <!-- Field Properties Editor -->
        @if (selectedField(); as field) {
          <section class="properties-section">
            <h3>‚öôÔ∏è Field Properties</h3>
            <div class="properties-form">
              <div class="form-group">
                <label>Field Name</label>
                <input
                  type="text"
                  [value]="field.name"
                  (input)="updateFieldProperty('name', $any($event.target).value)"
                  class="form-control"
                >
              </div>

              <div class="form-group">
                <label>Label</label>
                <input
                  type="text"
                  [value]="field.label"
                  (input)="updateFieldProperty('label', $any($event.target).value)"
                  class="form-control"
                >
              </div>

              <div class="form-group">
                <label>Placeholder</label>
                <input
                  type="text"
                  [value]="field.placeholder || ''"
                  (input)="updateFieldProperty('placeholder', $any($event.target).value)"
                  class="form-control"
                >
              </div>

              <div class="form-group">
                <label>
                  <input
                    type="checkbox"
                    [checked]="field.validations?.required || false"
                    (change)="toggleRequired(field, $any($event.target).checked)"
                  >
                  Required
                </label>
              </div>

              <div class="form-group">
                <label>
                  <input
                    type="checkbox"
                    [checked]="field.readonly || false"
                    (change)="updateFieldProperty('readonly', $any($event.target).checked)"
                  >
                  Read Only
                </label>
              </div>

              <div class="form-group">
                <label>
                  <input
                    type="checkbox"
                    [checked]="field.disabled || false"
                    (change)="updateFieldProperty('disabled', $any($event.target).checked)"
                  >
                  Disabled
                </label>
              </div>

              <!-- Move to Section (Multi-Step Mode) -->
              @if (multiStepMode() && currentSections().length > 1) {
                <div class="form-group">
                  <label>Move to Section</label>
                  <select
                    class="form-control"
                    (change)="moveFieldToSection(selectedFieldIndex()!, Number($any($event.target).value))"
                  >
                    <option value="" disabled selected>-- Select Section --</option>
                    @for (section of currentSections(); track $index) {
                      @if ($index !== selectedSectionIndex()) {
                        <option [value]="$index">{{ section.title }}</option>
                      }
                    }
                  </select>
                </div>
              }

              <!-- Array Field Configuration -->
              @if (field.type === 'array' && field.arrayConfig) {
                <div class="array-config-section">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">üîÅ Array Configuration</h4>

                  <div class="form-group">
                    <label>Minimum Items</label>
                    <input
                      type="number"
                      [value]="field.arrayConfig.minItems || 0"
                      (input)="updateArrayConfig('minItems', Number($any($event.target).value))"
                      class="form-control"
                      min="0"
                    >
                  </div>

                  <div class="form-group">
                    <label>Maximum Items</label>
                    <input
                      type="number"
                      [value]="field.arrayConfig.maxItems || ''"
                      (input)="updateArrayConfig('maxItems', $any($event.target).value ? Number($any($event.target).value) : undefined)"
                      class="form-control"
                      min="1"
                      placeholder="Unlimited"
                    >
                  </div>

                  <div class="form-group">
                    <label>Initial Items</label>
                    <input
                      type="number"
                      [value]="field.arrayConfig.initialItems || 1"
                      (input)="updateArrayConfig('initialItems', Number($any($event.target).value))"
                      class="form-control"
                      min="0"
                    >
                  </div>

                  <div class="form-group">
                    <label>Add Button Text</label>
                    <input
                      type="text"
                      [value]="field.arrayConfig.addButtonText || ''"
                      (input)="updateArrayConfig('addButtonText', $any($event.target).value)"
                      class="form-control"
                      placeholder="Add Item"
                    >
                  </div>

                  <div class="form-group">
                    <label>Remove Button Text</label>
                    <input
                      type="text"
                      [value]="field.arrayConfig.removeButtonText || ''"
                      (input)="updateArrayConfig('removeButtonText', $any($event.target).value)"
                      class="form-control"
                      placeholder="Remove"
                    >
                  </div>

                  <h4 style="margin-top: 1rem;">Sub-Fields</h4>
                  <div class="array-subfields">
                    @for (subField of field.arrayConfig.fields || []; track $index) {
                      <div class="subfield-item" style="border: 1px solid #ddd; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px;">
                        <div class="form-group" style="margin-bottom: 0.5rem;">
                          <label style="font-size: 0.9em;">Type</label>
                          <select
                            [value]="subField.type"
                            (change)="updateArraySubFieldProperty(selectedFieldIndex()!, $index, 'type', $any($event.target).value)"
                            class="form-control"
                          >
                            <option value="text">Text</option>
                            <option value="email">Email</option>
                            <option value="password">Password</option>
                            <option value="number">Number</option>
                            <option value="textarea">Textarea</option>
                            <option value="select">Select</option>
                            <option value="date">Date</option>
                          </select>
                        </div>

                        <div class="form-group" style="margin-bottom: 0.5rem;">
                          <label style="font-size: 0.9em;">Name</label>
                          <input
                            type="text"
                            [value]="subField.name"
                            (input)="updateArraySubFieldProperty(selectedFieldIndex()!, $index, 'name', $any($event.target).value)"
                            class="form-control"
                          >
                        </div>

                        <div class="form-group" style="margin-bottom: 0.5rem;">
                          <label style="font-size: 0.9em;">Label</label>
                          <input
                            type="text"
                            [value]="subField.label"
                            (input)="updateArraySubFieldProperty(selectedFieldIndex()!, $index, 'label', $any($event.target).value)"
                            class="form-control"
                          >
                        </div>

                        <div class="form-group" style="margin-bottom: 0.5rem;">
                          <label style="font-size: 0.9em;">Placeholder</label>
                          <input
                            type="text"
                            [value]="subField.placeholder || ''"
                            (input)="updateArraySubFieldProperty(selectedFieldIndex()!, $index, 'placeholder', $any($event.target).value)"
                            class="form-control"
                          >
                        </div>

                        <button
                          class="btn btn-danger btn-sm"
                          (click)="removeArraySubField(selectedFieldIndex()!, $index)"
                          style="width: 100%; margin-top: 0.5rem;"
                        >
                          üóëÔ∏è Remove Sub-Field
                        </button>
                      </div>
                    }

                    <button
                      class="btn btn-primary"
                      (click)="addArraySubField(selectedFieldIndex()!)"
                      style="width: 100%; margin-top: 0.5rem;"
                    >
                      ‚ûï Add Sub-Field
                    </button>
                  </div>
                </div>
              }

              <!-- Number & Range Field Configuration -->
              @if (field.type === 'number' || field.type === 'range') {
                <div class="type-specific-config">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">{{ field.type === 'range' ? 'üéöÔ∏è' : 'üî¢' }} {{ field.type === 'range' ? 'Range' : 'Number' }} Configuration</h4>

                  <div class="form-group">
                    <label>Minimum Value</label>
                    <input
                      type="number"
                      [value]="field.min || 0"
                      (input)="updateFieldProperty('min', Number($any($event.target).value))"
                      class="form-control"
                    >
                  </div>

                  <div class="form-group">
                    <label>Maximum Value</label>
                    <input
                      type="number"
                      [value]="field.max || 100"
                      (input)="updateFieldProperty('max', Number($any($event.target).value))"
                      class="form-control"
                    >
                  </div>

                  <div class="form-group">
                    <label>Step</label>
                    <input
                      type="number"
                      [value]="field.step || 1"
                      (input)="updateFieldProperty('step', Number($any($event.target).value))"
                      class="form-control"
                      min="0.01"
                      step="0.01"
                    >
                  </div>
                </div>
              }

              <!-- Multi-Select Configuration -->
              @if (field.type === 'multiselect') {
                <div class="type-specific-config">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">‚òëÔ∏è Multi-Select Configuration</h4>

                  <div class="form-group">
                    <label>Minimum Selections</label>
                    <input
                      type="number"
                      [value]="field.minSelections || 0"
                      (input)="updateFieldProperty('minSelections', Number($any($event.target).value))"
                      class="form-control"
                      min="0"
                    >
                  </div>

                  <div class="form-group">
                    <label>Maximum Selections</label>
                    <input
                      type="number"
                      [value]="field.maxSelections || ''"
                      (input)="updateFieldProperty('maxSelections', $any($event.target).value ? Number($any($event.target).value) : undefined)"
                      class="form-control"
                      min="1"
                      placeholder="Unlimited"
                    >
                  </div>
                </div>
              }

              <!-- DateTime Configuration -->
              @if (field.type === 'datetime') {
                <div class="type-specific-config">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">üìÖ DateTime Configuration</h4>

                  <div class="form-group">
                    <label>
                      <input
                        type="checkbox"
                        [checked]="field.includeTime !== false"
                        (change)="updateFieldProperty('includeTime', $any($event.target).checked)"
                      >
                      Include Time
                    </label>
                  </div>

                  <div class="form-group">
                    <label>Timezone</label>
                    <input
                      type="text"
                      [value]="field.timezone || ''"
                      (input)="updateFieldProperty('timezone', $any($event.target).value)"
                      class="form-control"
                      placeholder="e.g., America/New_York"
                    >
                  </div>
                </div>
              }

              <!-- File Upload Configuration -->
              @if (field.type === 'file') {
                <div class="type-specific-config">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">üìé File Upload Configuration</h4>

                  <div class="form-group">
                    <label>Accepted File Types</label>
                    <input
                      type="text"
                      [value]="field.accept || ''"
                      (input)="updateFieldProperty('accept', $any($event.target).value)"
                      class="form-control"
                      placeholder="e.g., image/*, .pdf, .doc"
                    >
                  </div>

                  <div class="form-group">
                    <label>Max File Size (bytes)</label>
                    <input
                      type="number"
                      [value]="field.maxFileSize || 5242880"
                      (input)="updateFieldProperty('maxFileSize', Number($any($event.target).value))"
                      class="form-control"
                    >
                    <small class="text-muted">5MB = 5242880 bytes, 10MB = 10485760 bytes</small>
                  </div>

                  <div class="form-group">
                    <label>
                      <input
                        type="checkbox"
                        [checked]="field.multiple || false"
                        (change)="updateFieldProperty('multiple', $any($event.target).checked)"
                      >
                      Allow Multiple Files
                    </label>
                  </div>
                </div>
              }

              <!-- Rich Text Configuration -->
              @if (field.type === 'richtext') {
                <div class="type-specific-config">
                  <h4 style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">üìù Rich Text Configuration</h4>

                  <div class="form-group">
                    <label>Maximum Characters</label>
                    <input
                      type="number"
                      [value]="field.maxCharacters || ''"
                      (input)="updateFieldProperty('maxCharacters', $any($event.target).value ? Number($any($event.target).value) : undefined)"
                      class="form-control"
                      min="1"
                      placeholder="Unlimited"
                    >
                  </div>
                </div>
              }
            </div>
          </section>
        }
      </div>
    </div>

    <!-- Panel 2: Live Preview -->
    <div class="panel live-preview">
      <div class="panel-header">
        <h2>üëÅÔ∏è Live Preview</h2>
      </div>

      <div class="panel-body">
        <div class="preview-container">
          @if (multiStepMode() && (!schema().sections || schema().sections?.length === 0)) {
            <div class="empty-state">
              <h3>No sections yet</h3>
              <p>Add sections to see the multi-step form preview</p>
            </div>
          } @else if (!multiStepMode() && (!schema().fields || schema().fields?.length === 0)) {
            <div class="empty-state">
              <h3>No fields yet</h3>
              <p>Add fields from the palette to see them here</p>
            </div>
          } @else {
            <dq-dynamic-form [formSchema]="schema()"></dq-dynamic-form>
          }
        </div>
      </div>
    </div>

    <!-- Panel 3: JSON Editor & Validation -->
    <div class="panel json-editor">
      <div class="panel-header">
        <h2>üíª JSON Schema</h2>
      </div>

      <div class="panel-body">
        <!-- JSON Editor -->
        <section class="json-section">
          <textarea
            class="json-textarea"
            [value]="jsonContent()"
            (input)="jsonContent.set($any($event.target).value); onJsonChange()"
            spellcheck="false"
          ></textarea>
        </section>

        <!-- Validation Results -->
        <section class="validation-section">
          <h3>
            @if (validationResult()?.isValid) {
              ‚úÖ Valid Schema
            } @else {
              ‚ùå Validation Issues
            }
          </h3>

          @if (validationResult(); as result) {
            <!-- Summary -->
            <div class="validation-summary">
              <div class="summary-item">
                <strong>Total Fields:</strong> {{ result.summary.totalFields }}
              </div>
              <div class="summary-item">
                <strong>Required:</strong> {{ result.summary.requiredFields }}
              </div>
              <div class="summary-item">
                <strong>Errors:</strong> <span [class.error]="result.summary.errorCount > 0">{{ result.summary.errorCount }}</span>
              </div>
              <div class="summary-item">
                <strong>Warnings:</strong> <span [class.warning]="result.summary.warningCount > 0">{{ result.summary.warningCount }}</span>
              </div>
            </div>

            <!-- Errors -->
            @if (result.errors.length > 0) {
              <div class="validation-errors">
                <h4>‚ùå Errors</h4>
                <ul>
                  @for (error of result.errors; track $index) {
                    <li class="error-item">{{ error }}</li>
                  }
                </ul>
              </div>
            }

            <!-- Warnings -->
            @if (result.warnings.length > 0) {
              <div class="validation-warnings">
                <h4>‚ö†Ô∏è Warnings</h4>
                <ul>
                  @for (warning of result.warnings; track $index) {
                    <li class="warning-item">{{ warning }}</li>
                  }
                </ul>
              </div>
            }

            <!-- Field Types -->
            @if (result.summary.fieldTypes && getFieldTypesEntries(result.summary.fieldTypes).length > 0) {
              <div class="field-types">
                <h4>üìä Field Types</h4>
                <ul>
                  @for (entry of getFieldTypesEntries(result.summary.fieldTypes); track entry[0]) {
                    <li>{{ entry[0] }}: {{ entry[1] }}</li>
                  }
                </ul>
              </div>
            }
          }
        </section>
      </div>
    </div>
  </div>
</div>
