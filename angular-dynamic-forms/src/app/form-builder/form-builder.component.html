<div class="form-builder">
  <!-- Header -->
  <div class="builder-header">
    <h1>üé® Dynamic Form Builder</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="toggleMultiStep()">
        {{ multiStepEnabled() ? 'üìÑ Single-Step' : 'üìë Multi-Step' }}
      </button>
      <button class="btn btn-secondary" (click)="toggleLivePreview()">
        {{ showLivePreview() ? 'üîç Hide Preview' : 'üëÅÔ∏è Show Preview' }}
      </button>
      <button class="btn btn-secondary" (click)="toggleJsonPreview()">
        {{ showJsonPreview() ? 'Hide JSON' : 'Show JSON' }}
      </button>
      <button class="btn btn-secondary" (click)="copyToClipboard()">üìã Copy JSON</button>
      <button class="btn btn-secondary" (click)="exportConfig()">üíæ Export</button>
      <label class="btn btn-secondary">
        üìÇ Import
        <input type="file" accept=".json" (change)="importConfig($event)" style="display: none;" />
      </label>
      <button class="btn btn-danger" (click)="clearForm()">üóëÔ∏è Clear</button>
    </div>
  </div>

  <div class="builder-content">
    <!-- Left Panel: Field Types -->
    <div class="field-types-panel">
      <h3>Field Types</h3>
      <p class="panel-description">Click to add a field to your form</p>
      <div class="field-types-grid">
        @for (fieldType of availableFieldTypes; track fieldType.type) {
        <div class="field-type-card" (click)="addField(fieldType.type)">
          <div class="field-type-icon">{{ fieldType.icon }}</div>
          <div class="field-type-label">{{ fieldType.label }}</div>
          <div class="field-type-desc">{{ fieldType.description }}</div>
        </div>
        }
      </div>
    </div>

    <!-- Middle Panel: Form Structure -->
    <div class="form-preview-panel">
      <div class="panel-header">
        <h3>{{ multiStepEnabled() ? 'Form Sections' : 'Form Fields' }}</h3>
        <div class="form-title-edit">
          <input
            type="text"
            [value]="formTitle()"
            (input)="formTitle.set($any($event.target).value)"
            placeholder="Form Title"
            class="title-input"
          />
        </div>
      </div>

      @if (multiStepEnabled()) {
        <!-- Multi-step: Show sections and their fields -->
        @if (sections().length === 0) {
          <div class="empty-state">
            <div class="empty-icon">üìë</div>
            <h4>No sections yet</h4>
            <button class="btn btn-primary" (click)="addSection()">+ Add Section</button>
          </div>
        } @else {
          <div class="sections-list">
            @for (section of sections(); track $index; let sectionIndex = $index) {
              <div class="section-card" [class.active]="currentSection() === sectionIndex">
                <div class="section-header" (click)="selectSection(sectionIndex)">
                  <span class="section-number">{{ sectionIndex + 1 }}</span>
                  <div class="section-info">
                    <strong>{{ section.title }}</strong>
                    <small>{{ section.fields.length }} field(s)</small>
                  </div>
                  @if (sections().length > 1) {
                    <button class="btn-icon btn-remove" (click)="removeSection(sectionIndex); $event.stopPropagation()" title="Remove section">
                      √ó
                    </button>
                  }
                </div>

                @if (currentSection() === sectionIndex) {
                  <div class="section-fields">
                    @if (section.fields.length === 0) {
                      <div class="empty-state-small">
                        <p>No fields in this section. Add fields from the left panel.</p>
                      </div>
                    } @else {
                      @for (field of section.fields; track field.name; let i = $index) {
                        <div
                          class="field-item"
                          [class.selected]="selectedFieldIndex() === i"
                          (click)="selectField(i)"
                          draggable="true"
                          (dragstart)="onDragStart(i)"
                          (dragover)="onDragOver($event)"
                          (drop)="onDrop($event, i)"
                        >
                          <div class="field-item-header">
                            <span class="drag-handle">‚ò∞</span>
                            <span class="field-type-badge">{{ field.type }}</span>
                            <span class="field-label">{{ field.label }}</span>
                            <button class="btn-icon btn-remove" (click)="removeField(i); $event.stopPropagation()" title="Remove field">
                              √ó
                            </button>
                          </div>
                          <div class="field-item-meta">
                            <small>Name: {{ field.name }}</small>
                            @if (field.validations?.required) {
                              <span class="badge badge-required">Required</span>
                            }
                          </div>
                        </div>
                      }
                    }
                  </div>
                }
              </div>
            }
          </div>
          <button class="btn btn-primary btn-add-section" (click)="addSection()">+ Add Section</button>
        }
      } @else {
        <!-- Single-step: Show flat fields list -->
        @if (formFields().length === 0) {
          <div class="empty-state">
            <div class="empty-icon">üìù</div>
            <h4>No fields yet</h4>
            <p>Add fields from the left panel to start building your form</p>
          </div>
        } @else {
          <div class="fields-list">
            @for (field of formFields(); track field.name; let i = $index) {
              <div
                class="field-item"
                [class.selected]="selectedFieldIndex() === i"
                (click)="selectField(i)"
                draggable="true"
                (dragstart)="onDragStart(i)"
                (dragover)="onDragOver($event)"
                (drop)="onDrop($event, i)"
              >
                <div class="field-item-header">
                  <span class="drag-handle">‚ò∞</span>
                  <span class="field-type-badge">{{ field.type }}</span>
                  <span class="field-label">{{ field.label }}</span>
                  <button class="btn-icon btn-remove" (click)="removeField(i); $event.stopPropagation()" title="Remove field">
                    √ó
                  </button>
                </div>
                <div class="field-item-meta">
                  <small>Name: {{ field.name }}</small>
                  @if (field.validations?.required) {
                    <span class="badge badge-required">Required</span>
                  }
                </div>
              </div>
            }
          </div>
        }
      }
    </div>

    <!-- Right Panel: Field Properties -->
    <div class="field-properties-panel">
      <h3>{{ selectedField() ? 'Field Properties' : (multiStepEnabled() ? 'Section Properties' : 'Field Properties') }}</h3>

      @if (selectedField()) {
      <div class="properties-form">
        <!-- Basic Properties -->
        <div class="property-group">
          <h4>Basic</h4>

          <label>
            <span>Label</span>
            <input
              type="text"
              [value]="selectedField()!.label"
              (input)="updateFieldProperty('label', $any($event.target).value)"
            />
          </label>

          <label>
            <span>Name (Field ID)</span>
            <input
              type="text"
              [value]="selectedField()!.name"
              (input)="updateFieldProperty('name', $any($event.target).value)"
            />
          </label>

          <label>
            <span>Placeholder</span>
            <input
              type="text"
              [value]="selectedField()!.placeholder || ''"
              (input)="updateFieldProperty('placeholder', $any($event.target).value)"
            />
          </label>
        </div>

        <!-- Type-Specific Properties -->
        @if (selectedField()!.type === 'textarea') {
        <div class="property-group">
          <h4>Text Area Settings</h4>
          <label>
            <span>Rows</span>
            <input
              type="number"
              [value]="selectedField()!.rows || 4"
              (input)="updateFieldProperty('rows', Number($any($event.target).value))"
              min="1"
              max="20"
            />
          </label>
        </div>
        }

        @if (selectedField()!.type === 'number' || selectedField()!.type === 'range') {
        <div class="property-group">
          <h4>{{ selectedField()!.type === 'number' ? 'Number' : 'Range' }} Settings</h4>
          <label>
            <span>Minimum</span>
            <input
              type="number"
              [value]="selectedField()!.min || 0"
              (input)="updateFieldProperty('min', Number($any($event.target).value))"
            />
          </label>
          <label>
            <span>Maximum</span>
            <input
              type="number"
              [value]="selectedField()!.max || 100"
              (input)="updateFieldProperty('max', Number($any($event.target).value))"
            />
          </label>
          <label>
            <span>Step</span>
            <input
              type="number"
              [value]="selectedField()!.step || 1"
              (input)="updateFieldProperty('step', Number($any($event.target).value))"
            />
          </label>
        </div>
        }

        @if (selectedField()!.type === 'date' || selectedField()!.type === 'datetime') {
        <div class="property-group">
          <h4>Date Settings</h4>
          <label>
            <span>Minimum Date</span>
            <input
              type="{{ selectedField()!.type === 'datetime' ? 'datetime-local' : 'date' }}"
              [value]="selectedField()!.min || ''"
              (input)="updateFieldProperty('min', $any($event.target).value)"
            />
          </label>
          <label>
            <span>Maximum Date</span>
            <input
              type="{{ selectedField()!.type === 'datetime' ? 'datetime-local' : 'date' }}"
              [value]="selectedField()!.max || ''"
              (input)="updateFieldProperty('max', $any($event.target).value)"
            />
          </label>
        </div>
        }

        @if (selectedField()!.type === 'file') {
        <div class="property-group">
          <h4>File Upload Settings</h4>
          <label>
            <span>Accept Types</span>
            <input
              type="text"
              [value]="selectedField()!.accept || ''"
              (input)="updateFieldProperty('accept', $any($event.target).value)"
              placeholder="e.g., image/*,.pdf"
            />
          </label>
          <label>
            <span>Max File Size (bytes)</span>
            <input
              type="number"
              [value]="selectedField()!.maxFileSize || 5242880"
              (input)="updateFieldProperty('maxFileSize', Number($any($event.target).value))"
            />
          </label>
          <label class="checkbox-label">
            <input
              type="checkbox"
              [checked]="selectedField()!.multiple || false"
              (change)="updateFieldProperty('multiple', $any($event.target).checked)"
            />
            <span>Allow Multiple Files</span>
          </label>
        </div>
        }

        @if (selectedField()!.type === 'multiselect') {
        <div class="property-group">
          <h4>Multi-Select Settings</h4>
          <label>
            <span>Min Selections</span>
            <input
              type="number"
              [value]="selectedField()!.minSelections || ''"
              (input)="updateFieldProperty('minSelections', Number($any($event.target).value))"
            />
          </label>
          <label>
            <span>Max Selections</span>
            <input
              type="number"
              [value]="selectedField()!.maxSelections || ''"
              (input)="updateFieldProperty('maxSelections', Number($any($event.target).value))"
            />
          </label>
        </div>
        }

        <!-- Radio Layout -->
        @if (selectedField()!.type === 'radio') {
        <div class="property-group">
          <h4>Radio Settings</h4>
          <label>
            <span>Layout</span>
            <select
              class="form-select"
              [value]="selectedField()!.layout || 'vertical'"
              (change)="updateFieldProperty('layout', $any($event.target).value)"
            >
              <option value="vertical">Vertical</option>
              <option value="horizontal">Horizontal</option>
            </select>
          </label>
        </div>
        }

        <!-- Options (for select/multiselect/radio) -->
        @if (selectedField()!.type === 'select' || selectedField()!.type === 'multiselect' || selectedField()!.type === 'radio') {
        <div class="property-group">
          <h4>Options</h4>
          <div class="options-list">
            @for (option of selectedField()!.options; track option; let i = $index) {
            <div class="option-item">
              <input
                type="text"
                [value]="$any(option).value"
                (input)="updateOption(i, 'value', $any($event.target).value)"
                placeholder="Value"
              />
              <input
                type="text"
                [value]="$any(option).label"
                (input)="updateOption(i, 'label', $any($event.target).value)"
                placeholder="Label"
              />
              <button class="btn-icon" (click)="removeOption(i)">√ó</button>
            </div>
            }
          </div>
          <button class="btn btn-secondary btn-small" (click)="addOption()">+ Add Option</button>
        </div>
        }

        <!-- Array (Repeater) Settings -->
        @if (selectedField()!.type === 'array') {
        <div class="property-group">
          <h4>Repeater Settings</h4>
          <label>
            <span>Min Items</span>
            <input
              type="number"
              [value]="selectedField()!.arrayConfig?.minItems || 1"
              (input)="updateArrayConfig('minItems', Number($any($event.target).value))"
              min="0"
            />
          </label>
          <label>
            <span>Max Items</span>
            <input
              type="number"
              [value]="selectedField()!.arrayConfig?.maxItems || 10"
              (input)="updateArrayConfig('maxItems', Number($any($event.target).value))"
              min="1"
            />
          </label>
          <label>
            <span>Initial Items</span>
            <input
              type="number"
              [value]="selectedField()!.arrayConfig?.initialItems || 1"
              (input)="updateArrayConfig('initialItems', Number($any($event.target).value))"
              min="1"
            />
          </label>
          <label>
            <span>Item Label</span>
            <input
              type="text"
              [value]="selectedField()!.arrayConfig?.itemLabel || ''"
              (input)="updateArrayConfig('itemLabel', $any($event.target).value)"
              placeholder="e.g., {label} {index}"
            />
          </label>
          <label>
            <span>Add Button Text</span>
            <input
              type="text"
              [value]="selectedField()!.arrayConfig?.addButtonText || ''"
              (input)="updateArrayConfig('addButtonText', $any($event.target).value)"
              placeholder="e.g., + Add {label}"
            />
          </label>
          <label>
            <span>Remove Button Text</span>
            <input
              type="text"
              [value]="selectedField()!.arrayConfig?.removeButtonText || ''"
              (input)="updateArrayConfig('removeButtonText', $any($event.target).value)"
              placeholder="e.g., Remove"
            />
          </label>
          <small class="text-muted">Note: Array field configuration requires advanced setup. Edit the JSON directly for complex nested fields.</small>
        </div>
        }

        <!-- Validations -->
        <div class="property-group">
          <h4>Validations</h4>

          <label class="checkbox-label">
            <input
              type="checkbox"
              [checked]="selectedField()!.validations?.required || false"
              (change)="updateFieldValidation('required', $any($event.target).checked)"
            />
            <span>Required</span>
          </label>

          @if (selectedField()!.type === 'text' || selectedField()!.type === 'email' || selectedField()!.type === 'password' || selectedField()!.type === 'textarea') {
          <label>
            <span>Min Length</span>
            <input
              type="number"
              [value]="selectedField()!.validations?.minLength || ''"
              (input)="updateFieldValidation('minLength', Number($any($event.target).value))"
            />
          </label>
          <label>
            <span>Max Length</span>
            <input
              type="number"
              [value]="selectedField()!.validations?.maxLength || ''"
              (input)="updateFieldValidation('maxLength', Number($any($event.target).value))"
            />
          </label>
          }

          @if (selectedField()!.type === 'checkbox') {
          <label class="checkbox-label">
            <input
              type="checkbox"
              [checked]="selectedField()!.validations?.requiredTrue || false"
              (change)="updateFieldValidation('requiredTrue', $any($event.target).checked)"
            />
            <span>Must be checked</span>
          </label>
          }
        </div>
      </div>
      } @else {
        @if (multiStepEnabled() && sections().length > 0) {
          <!-- Show section properties editor -->
          <div class="properties-form">
            <div class="property-group">
              <h4>Section Details</h4>

              <label>
                <span>Title</span>
                <input
                  type="text"
                  [value]="sections()[currentSection()]?.title || ''"
                  (input)="updateSectionProperty(currentSection(), 'title', $any($event.target).value)"
                  placeholder="Section Title"
                />
              </label>

              <label>
                <span>Description</span>
                <input
                  type="text"
                  [value]="sections()[currentSection()]?.description || ''"
                  (input)="updateSectionProperty(currentSection(), 'description', $any($event.target).value)"
                  placeholder="Section Description"
                />
              </label>

              <label>
                <span>Icon (emoji)</span>
                <input
                  type="text"
                  [value]="sections()[currentSection()]?.icon || ''"
                  (input)="updateSectionProperty(currentSection(), 'icon', $any($event.target).value)"
                  placeholder="e.g., üë§ üìù ‚öôÔ∏è"
                  maxlength="2"
                />
              </label>
            </div>
          </div>
        } @else {
          <div class="empty-state">
            <div class="empty-icon">‚öôÔ∏è</div>
            <p>Select a field to edit its properties</p>
          </div>
        }
      }
    </div>
  </div>

  <!-- Live Preview Panel -->
  @if (showLivePreview()) {
  <div class="live-preview-panel">
    <div class="panel-header">
      <h3>üîç Live Preview</h3>
      <button class="btn btn-small btn-secondary" (click)="toggleLivePreview()">Close</button>
    </div>
    <div class="live-preview-content">
      @if (multiStepEnabled() && sections().length === 0) {
        <div class="preview-empty-state">
          <p>Add sections to see the live preview</p>
        </div>
      } @else if (!multiStepEnabled() && formFields().length === 0) {
        <div class="preview-empty-state">
          <p>Add fields to see the live preview</p>
        </div>
      } @else {
        <dq-dynamic-form [formSchema]="formSchema()" />
      }
    </div>
  </div>
  }

  <!-- JSON Preview Panel -->
  @if (showJsonPreview()) {
  <div class="json-preview-panel">
    <div class="panel-header">
      <h3>JSON Configuration</h3>
      <button class="btn btn-small btn-secondary" (click)="copyToClipboard()">Copy</button>
    </div>
    <pre class="json-code">{{ formJson() }}</pre>
  </div>
  }
</div>
