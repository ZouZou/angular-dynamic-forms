<!-- Loading State -->
@if (loading()) {
<div class="loading-container">
  <div class="spinner"></div>
  <p class="loading-text">Loading form...</p>
</div>
}

<!-- Form -->
@if (!loading() && fields().length && !submitted()) {
<div class="form-container">
  <h2>{{ title() }}</h2>

  <!-- Autosave indicator -->
  @if (autosaveEnabled() && lastSaved()) {
  <div class="autosave-indicator">
    <span class="autosave-icon">üíæ</span>
    <span class="autosave-text">{{ lastSavedText() }}</span>
  </div>
  }

  <!-- Multi-step progress indicator -->
  @if (multiStepEnabled()) {
  <div class="multi-step-progress">
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
    </div>
    <div class="step-indicators">
      @for (section of sections(); track $index) {
      <div class="step-indicator"
           [class.active]="$index === currentStep()"
           [class.completed]="isStepComplete($index)"
           (click)="goToStep($index)">
        <div class="step-number">
          @if (isStepComplete($index)) {
            <span class="checkmark">‚úì</span>
          } @else {
            {{ $index + 1 }}
          }
        </div>
        <div class="step-label">{{ section.title }}</div>
      </div>
      }
    </div>
  </div>

  <!-- Current step info -->
  <div class="current-step-header">
    <h3 class="step-title">
      @if (sections()[currentStep()]?.icon) {
        <span class="step-icon">{{ sections()[currentStep()].icon }}</span>
      }
      {{ sections()[currentStep()]?.title }}
    </h3>
    @if (sections()[currentStep()]?.description) {
      <p class="step-description">{{ sections()[currentStep()].description }}</p>
    }
  </div>
  }

  <form role="form" aria-label="{{ title() }}">
    @for (field of currentStepFields(); track field.name) {
    <!-- Only show field if visibility condition is met -->
    @if (isFieldVisible(field)) {
    <div class="form-group" [@fieldAnimation] [class]="'width-' + (field.width || 'full') + (field.cssClass ? ' ' + field.cssClass : '')" role="group" [attr.aria-labelledby]="'label-' + field.name">
      <!-- Text / Email / Password -->
      @if (field.type === 'text' || field.type === 'email' || field.type === 'password') {
      <label class="form-label" [id]="'label-' + field.name" [attr.for]="field.name">
        {{ field.label }}
        @if (field.validations?.required || field.validations?.requiredIf) {
        <span class="required" aria-label="required">*</span>
        }
        @if (field.mask) {
        <span class="mask-hint" [title]="'Format: ' + getMaskPattern(field)">
          ({{ getMaskPattern(field) }})
        </span>
        }
        @if (field.validations?.asyncValidator) {
        @if (asyncValidationState()[field.name] === 'validating') {
        <span class="async-validation-indicator validating" role="status" aria-live="polite">‚è≥ Validating...</span>
        }
        @if (asyncValidationState()[field.name] === 'valid') {
        <span class="async-validation-indicator valid" role="status" aria-live="polite">‚úì Valid</span>
        }
        }
      </label>
      <input
        [type]="field.type"
        [id]="field.name"
        [name]="field.name"
        class="form-control"
        [class.masked-input]="!!field.mask"
        [value]="formValues()[field.name]"
        [placeholder]="field.placeholder || (field.mask ? getMaskPattern(field) : 'Enter ' + field.label.toLowerCase())"
        [readonly]="field.readonly || !!field.computed || false"
        [disabled]="field.disabled || false"
        [attr.maxlength]="field.mask ? getMaxLength(field) : null"
        [attr.aria-required]="field.validations?.required || field.validations?.requiredIf || null"
        [attr.aria-invalid]="touched()[field.name] && errors()[field.name] ? 'true' : null"
        [attr.aria-describedby]="errors()[field.name] ? 'error-' + field.name : null"
        [attr.title]="field.mask ? 'Format: ' + getMaskPattern(field) : null"
        (input)="field.mask ? updateMaskedFormValue(field.name, $any($event.target).value, field) : updateFormValue(field.name, $any($event.target).value)"
      />
      }

      <!-- Textarea -->
      @if (field.type === 'textarea') {
      <label class="form-label">
        {{ field.label }}
        @if (field.validations?.required) {
        <span class="required">*</span>
        }
      </label>
      <textarea
        class="form-control"
        [value]="formValues()[field.name]"
        [placeholder]="field.placeholder || 'Enter ' + field.label.toLowerCase()"
        [rows]="field.rows || 4"
        (input)="updateFormValue(field.name, $any($event.target).value)"
      ></textarea>
      }

      <!-- Number -->
      @if (field.type === 'number') {
      <label class="form-label">
        {{ field.label }}
        @if (field.validations?.required) {
        <span class="required">*</span>
        }
      </label>
      <input
        type="number"
        class="form-control"
        [value]="formValues()[field.name]"
        [placeholder]="field.placeholder || 'Enter ' + field.label.toLowerCase()"
        [min]="field.min"
        [max]="field.max"
        [step]="field.step || 1"
        (input)="updateFormValue(field.name, $any($event.target).valueAsNumber)"
      />
      }

      <!-- Date -->
      @if (field.type === 'date') {
      <label class="form-label">
        {{ field.label }}
        @if (field.validations?.required) {
        <span class="required">*</span>
        }
      </label>
      <input
        type="date"
        class="form-control"
        [value]="formValues()[field.name]"
        [min]="field.min"
        [max]="field.max"
        (input)="updateFormValue(field.name, $any($event.target).value)"
      />
      }

      <!-- Radio Buttons -->
      @if (field.type === 'radio') {
      <label class="form-label">
        {{ field.label }}
        @if (field.validations?.required) {
        <span class="required">*</span>
        }
      </label>
      <div class="radio-group" [class.radio-horizontal]="field.layout === 'horizontal'">
        @for (opt of normalizeOptions(field.options || []); track opt.value) {
        <div class="radio-option">
          <input
            type="radio"
            [name]="field.name"
            [value]="opt.value"
            [checked]="formValues()[field.name] === opt.value"
            (change)="updateFormValue(field.name, opt.value)"
          />
          <label>{{ opt.label }}</label>
        </div>
        }
      </div>
      }

      <!-- Select -->
      @if (field.type === 'select') {
      <label class="form-label">
        {{ field.label }}
        @if (field.validations?.required) {
        <span class="required">*</span>
        }
        @if (fieldLoading()[field.name]) {
        <span class="loading-indicator">Loading...</span>
        }
      </label>
      <select
        class="form-select"
        [disabled]="isFieldDisabled(field) || fieldLoading()[field.name]"
        (change)="updateFormValue(field.name, $any($event.target).value)"
      >
        <option value="" [selected]="!formValues()[field.name]">
          @if (fieldLoading()[field.name]) {
            Loading options...
          } @else {
            Choose {{ field.label.toLowerCase() }}
          }
        </option>
        @for (opt of getAvailableOptions(field); track opt.value) {
        <option [value]="opt.value" [selected]="formValues()[field.name] === opt.value">
          {{ opt.label }}
        </option>
        }
      </select>
      @if (isFieldDisabled(field)) {
      <small class="text-muted">Please fill in required dependencies first</small>
      }
      @if (fieldErrors()[field.name]) {
      <small class="text-error">{{ fieldErrors()[field.name] }}</small>
      }
      }

      <!-- Checkbox -->
      @if (field.type === 'checkbox') {
      <div class="checkbox-wrapper">
        <input
          type="checkbox"
          class="form-checkbox"
          [checked]="formValues()[field.name]"
          (change)="updateFormValue(field.name, $any($event.target).checked)"
        />
        <label class="form-label" style="margin: 0; text-transform: none;">
          {{ field.label }}
          @if (field.validations?.requiredTrue) {
          <span class="required">*</span>
          }
        </label>
      </div>
      }

      <!-- Range Slider -->
      @if (field.type === 'range') {
      <label class="form-label">
        {{ field.label }}
        @if (field.validations?.required) {
        <span class="required">*</span>
        }
        <span class="range-value">{{ formValues()[field.name] || field.min || 0 }}</span>
      </label>
      <input
        type="range"
        class="form-range"
        [min]="field.min || 0"
        [max]="field.max || 100"
        [step]="field.step || 1"
        [value]="formValues()[field.name] || field.min || 0"
        (input)="updateFormValue(field.name, Number($any($event.target).value))"
      />
      <div class="range-labels">
        <small>{{ field.min || 0 }}</small>
        <small>{{ field.max || 100 }}</small>
      </div>
      }

      <!-- Color Picker -->
      @if (field.type === 'color') {
      <label class="form-label">
        {{ field.label }}
        @if (field.validations?.required) {
        <span class="required">*</span>
        }
      </label>
      <div class="color-picker-wrapper">
        <input
          type="color"
          class="form-color"
          [value]="formValues()[field.name] || '#000000'"
          (input)="updateFormValue(field.name, $any($event.target).value)"
        />
        <span class="color-hex">{{ formValues()[field.name] || '#000000' }}</span>
      </div>
      }

      <!-- Multi-Select -->
      @if (field.type === 'multiselect') {
      <label class="form-label">
        {{ field.label }}
        @if (field.validations?.required) {
        <span class="required">*</span>
        }
      </label>
      <select
        class="form-select"
        multiple
        [disabled]="isFieldDisabled(field) || fieldLoading()[field.name]"
        (change)="updateMultiSelectValue(field.name, $any($event.target).selectedOptions)"
        [size]="Math.min(getAvailableOptions(field).length, 6)"
      >
        @for (opt of getAvailableOptions(field); track opt.value) {
        <option [value]="opt.value" [selected]="isMultiSelectOptionSelected(field.name, opt.value)">
          {{ opt.label }}
        </option>
        }
      </select>
      <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
      @if (field.minSelections || field.maxSelections) {
      <small class="text-muted">
        @if (field.minSelections && field.maxSelections) {
          Select {{ field.minSelections }}-{{ field.maxSelections }} options
        } @else if (field.minSelections) {
          Select at least {{ field.minSelections }} options
        } @else if (field.maxSelections) {
          Select up to {{ field.maxSelections }} options
        }
      </small>
      }
      }

      <!-- DateTime Picker -->
      @if (field.type === 'datetime') {
      <label class="form-label">
        {{ field.label }}
        @if (field.validations?.required) {
        <span class="required">*</span>
        }
      </label>
      <input
        type="datetime-local"
        class="form-control"
        [value]="formValues()[field.name]"
        [min]="field.min"
        [max]="field.max"
        [placeholder]="field.placeholder || 'Select date and time'"
        (input)="updateFormValue(field.name, $any($event.target).value)"
      />
      @if (field.timezone) {
      <small class="text-muted">Timezone: {{ field.timezone }}</small>
      }
      }

      <!-- File Upload -->
      @if (field.type === 'file') {
      <label class="form-label">
        {{ field.label }}
        @if (field.validations?.required) {
        <span class="required">*</span>
        }
      </label>
      <input
        type="file"
        class="form-file"
        [accept]="field.accept || ''"
        [multiple]="field.multiple || false"
        (change)="handleFileUpload(field.name, $any($event.target).files, field)"
      />
      @if (field.maxFileSize) {
      <small class="text-muted">Max size: {{ formatFileSize(field.maxFileSize) }}</small>
      }
      @if (formValues()[field.name]) {
      <div class="file-preview">
        @if (isImage(formValues()[field.name])) {
        <img [src]="getFilePreview(field.name)" alt="Preview" class="image-preview" />
        } @else {
        <div class="file-info">
          <strong>{{ getFileName(formValues()[field.name]) }}</strong>
          <small>{{ getFileSize(field.name) }}</small>
        </div>
        }
      </div>
      }
      }

      <!-- Rich Text Editor (Basic) -->
      @if (field.type === 'richtext') {
      <label class="form-label">
        {{ field.label }}
        @if (field.validations?.required) {
        <span class="required">*</span>
        }
      </label>
      <div class="richtext-toolbar">
        <button type="button" (click)="execCommand('bold')" title="Bold">B</button>
        <button type="button" (click)="execCommand('italic')" title="Italic">I</button>
        <button type="button" (click)="execCommand('underline')" title="Underline">U</button>
        <button type="button" (click)="execCommand('insertUnorderedList')" title="Bullet List">‚Ä¢</button>
        <button type="button" (click)="execCommand('insertOrderedList')" title="Numbered List">1.</button>
      </div>
      <div
        class="richtext-editor"
        contenteditable="true"
        [id]="'richtext-' + field.name"
        (input)="updateRichTextValue(field.name, $any($event.target).innerHTML)"
        [innerHTML]="formValues()[field.name] || ''"
      ></div>
      @if (field.maxCharacters) {
      <small class="text-muted">
        {{ getRichTextLength(formValues()[field.name]) }} / {{ field.maxCharacters }} characters
      </small>
      }
      }

      <!-- Dynamic Field Array (Repeater) -->
      @if (field.type === 'array' && field.arrayConfig) {
      <div class="array-field-container">
        <label class="form-label">{{ field.label }}</label>

        @for (index of getArrayIndices(field.name); track index) {
        <div class="array-item">
          <div class="array-item-header">
            <span class="array-item-label">
              {{ field.arrayConfig.itemLabel ? field.arrayConfig.itemLabel.replace('{label}', field.label).replace('{index}', (index + 1).toString()) : field.label + ' ' + (index + 1) }}
            </span>
            <button
              type="button"
              class="array-remove-btn"
              [disabled]="!canRemoveArrayItem(field)"
              (click)="removeArrayItem(field, index)"
              title="Remove this item"
            >
              {{ field.arrayConfig.removeButtonText || 'Remove' }}
            </button>
          </div>

          <div class="array-item-fields">
            @for (subField of field.arrayConfig.fields; track subField.name) {
            <div class="form-group" [class]="'width-' + (subField.width || 'full')">
              <!-- Text / Email / Password -->
              @if (subField.type === 'text' || subField.type === 'email' || subField.type === 'password') {
              <label class="form-label">
                {{ subField.label }}
                @if (subField.validations?.required) {
                <span class="required">*</span>
                }
              </label>
              <input
                [type]="subField.type"
                class="form-control"
                [value]="formValues()[getArrayFieldName(field.name, index, subField.name)]"
                [placeholder]="subField.placeholder || 'Enter ' + subField.label.toLowerCase()"
                (input)="updateFormValue(getArrayFieldName(field.name, index, subField.name), $any($event.target).value)"
              />
              }

              <!-- Number -->
              @if (subField.type === 'number') {
              <label class="form-label">
                {{ subField.label }}
                @if (subField.validations?.required) {
                <span class="required">*</span>
                }
              </label>
              <input
                type="number"
                class="form-control"
                [value]="formValues()[getArrayFieldName(field.name, index, subField.name)]"
                [placeholder]="subField.placeholder || 'Enter ' + subField.label.toLowerCase()"
                [min]="subField.min"
                [max]="subField.max"
                [step]="subField.step || 1"
                (input)="updateFormValue(getArrayFieldName(field.name, index, subField.name), $any($event.target).valueAsNumber)"
              />
              }

              <!-- Select -->
              @if (subField.type === 'select') {
              <label class="form-label">
                {{ subField.label }}
                @if (subField.validations?.required) {
                <span class="required">*</span>
                }
              </label>
              <select
                class="form-select"
                (change)="updateFormValue(getArrayFieldName(field.name, index, subField.name), $any($event.target).value)"
              >
                <option value="" [selected]="!formValues()[getArrayFieldName(field.name, index, subField.name)]">Choose {{ subField.label.toLowerCase() }}</option>
                @for (opt of normalizeOptions(subField.options || []); track opt.value) {
                <option [value]="opt.value" [selected]="formValues()[getArrayFieldName(field.name, index, subField.name)] === opt.value">{{ opt.label }}</option>
                }
              </select>
              }

              <!-- Textarea -->
              @if (subField.type === 'textarea') {
              <label class="form-label">
                {{ subField.label }}
                @if (subField.validations?.required) {
                <span class="required">*</span>
                }
              </label>
              <textarea
                class="form-control"
                [value]="formValues()[getArrayFieldName(field.name, index, subField.name)]"
                [placeholder]="subField.placeholder || 'Enter ' + subField.label.toLowerCase()"
                [rows]="subField.rows || 4"
                (input)="updateFormValue(getArrayFieldName(field.name, index, subField.name), $any($event.target).value)"
              ></textarea>
              }

              <!-- Error -->
              @if (touched()[getArrayFieldName(field.name, index, subField.name)] && errors()[getArrayFieldName(field.name, index, subField.name)]) {
              <div class="error">
                {{ errors()[getArrayFieldName(field.name, index, subField.name)] }}
              </div>
              }
            </div>
            }
          </div>
        </div>
        }

        <button
          type="button"
          class="array-add-btn"
          [disabled]="!canAddArrayItem(field)"
          (click)="addArrayItem(field)"
        >
          {{ field.arrayConfig.addButtonText ? field.arrayConfig.addButtonText.replace('{label}', field.label) : '+ Add ' + field.label }}
        </button>
      </div>
      }

      <!-- Error -->
      @if (touched()[field.name] && errors()[field.name]) {
      <div [id]="'error-' + field.name" class="error" role="alert" aria-live="assertive">
        {{ errors()[field.name] }}
      </div>
      }
    </div>
    }
    }

    <!-- Submission Error Message -->
    @if (submitError()) {
    <div class="submission-error" role="alert" aria-live="assertive">
      <strong>Error:</strong> {{ submitError() }}
      @if (submitRetryCount() > 0) {
      <p class="retry-info">Retry attempt {{ submitRetryCount() }} of {{ 3 }}</p>
      }
      <button type="button" class="retry-btn" (click)="retrySubmit()">
        Retry Submission
      </button>
    </div>
    }

    <!-- Navigation Buttons -->
    @if (multiStepEnabled()) {
      <div class="multi-step-navigation">
        <!-- Previous Button -->
        @if (canGoToPreviousStep()) {
        <button
          type="button"
          class="nav-btn prev-btn"
          (click)="goToPreviousStep()"
          aria-label="Go to previous step"
        >
          ‚Üê Previous
        </button>
        }

        <!-- Next Button (shown on all steps except last) -->
        @if (canGoToNextStep()) {
        <button
          type="button"
          class="nav-btn next-btn"
          (click)="goToNextStep()"
          aria-label="Go to next step"
        >
          Next ‚Üí
        </button>
        }

        <!-- Submit Button (shown only on last step) -->
        @if (isLastStep()) {
        <button
          class="submit-btn"
          type="submit"
          [disabled]="!isValid() || submitting()"
          [attr.aria-disabled]="!isValid() || submitting()"
          [attr.aria-busy]="submitting()"
          (click)="saveUserData()"
          aria-label="Submit form"
        >
          @if (submitting()) {
          <span class="spinner"></span>
          Submitting{{ submitRetryCount() > 0 ? ' (Retry ' + submitRetryCount() + ')' : '' }}...
          } @else {
          Submit
          }
        </button>
        }
      </div>
    } @else {
      <!-- Single-step Submit Button -->
      <button
        class="submit-btn"
        type="submit"
        [disabled]="!isValid() || submitting()"
        [attr.aria-disabled]="!isValid() || submitting()"
        [attr.aria-busy]="submitting()"
        (click)="saveUserData()"
        aria-label="Submit form"
      >
        @if (submitting()) {
        <span class="spinner"></span>
        Submitting{{ submitRetryCount() > 0 ? ' (Retry ' + submitRetryCount() + ')' : '' }}...
        } @else {
        Submit
        }
      </button>
    }
  </form>
</div>
}

<!-- Success / Submitted Data -->
@if (submitted() && submitSuccess()) {
<div class="submitted-data success-message" role="status" aria-live="polite">
  <div class="success-icon">‚úì</div>
  <h3>Form Submitted Successfully!</h3>

  @if (submittedData()) {
  <ul>
    @for (field of fields(); track field.name) {
    <li>
      <strong>{{ field.label }}</strong>
      <span>{{ submittedData()?.[field.name] }}</span>
    </li>
    }
  </ul>
  }
</div>
}
