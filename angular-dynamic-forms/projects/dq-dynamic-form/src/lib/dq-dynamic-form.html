<!-- Loading State -->
@if (loading()) {
<div class="loading-container">
  <div class="spinner"></div>
  <p class="loading-text">Loading form...</p>
</div>
}

<!-- Form -->
@if (!loading() && fields().length && !submitted()) {
<div class="form-container">
  <h2>{{ title() }}</h2>

  <!-- Autosave indicator -->
  <dq-autosave-indicator
    [enabled]="autosaveEnabled()"
    [lastSaved]="lastSaved()"
  />

  <!-- Multi-step progress indicator -->
  @if (multiStepEnabled()) {
    <dq-multi-step-navigation
      [sections]="sections()"
      [currentStep]="currentStep()"
      [completedSteps]="completedSteps()"
      [showProgress]="true"
      [showNavigation]="false"
      [showSubmitButton]="false"
      [isValid]="isValid()"
      [submitting]="submitting()"
      (stepClick)="goToStep($event)"
      (nextClick)="goToNextStep()"
      (previousClick)="goToPreviousStep()"
      (submitClick)="saveUserData()"
    />
  }

  <form role="form" aria-label="{{ title() }}">
    <div class="form-fields-container">
    @for (field of currentStepFields(); track field.name) {
    <!-- Only show field if visibility condition is met -->
    @if (isFieldVisible(field)) {
    <div class="form-group" [@fieldAnimation] [class]="'width-' + (field.width || 'full') + (field.cssClass ? ' ' + field.cssClass : '')" role="group" [attr.aria-labelledby]="'label-' + field.name">
      <!-- Text / Email / Password -->
      @if (field.type === 'text' || field.type === 'email' || field.type === 'password') {
        <dq-text-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          [asyncValidationState]="asyncValidationState()[field.name] || 'idle'"
          [maskPattern]="getMaskPattern(field)"
          [maxLength]="getMaxLength(field)"
          (valueChange)="onFieldValueChange($event)"
          (blur)="onFieldBlur($event)"
        />
      }

      <!-- Textarea -->
      @if (field.type === 'textarea') {
        <dq-textarea-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          (valueChange)="onFieldValueChange($event)"
          (blur)="onFieldBlur($event)"
        />
      }

      <!-- Number -->
      @if (field.type === 'number') {
        <dq-number-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          (valueChange)="onFieldValueChange($event)"
          (blur)="onFieldBlur($event)"
        />
      }

      <!-- Date -->
      @if (field.type === 'date') {
        <dq-date-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          (valueChange)="onFieldValueChange($event)"
          (blur)="onFieldBlur($event)"
        />
      }

      <!-- Radio Buttons -->
      @if (field.type === 'radio') {
        <dq-radio-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          [options]="normalizeOptions(field.options || [])"
          (valueChange)="onFieldValueChange($event)"
          (blur)="onFieldBlur($event)"
        />
      }

      <!-- Select -->
      @if (field.type === 'select') {
        <dq-select-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          [options]="getAvailableOptions(field)"
          [loading]="fieldLoading()[field.name]"
          [disabled]="isFieldDisabled(field)"
          (valueChange)="onFieldValueChange($event)"
          (blur)="onFieldBlur($event)"
        />

        <dq-field-validation-display
          [fieldName]="field.name"
          [disabled]="isFieldDisabled(field)"
          [fieldError]="fieldErrors()[field.name]"
        />
      }

      <!-- Checkbox -->
      @if (field.type === 'checkbox') {
        <dq-checkbox-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          (valueChange)="onFieldValueChange($event)"
          (blur)="onFieldBlur($event)"
        />
      }

      <!-- Range Slider -->
      @if (field.type === 'range') {
        <dq-range-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          (valueChange)="onFieldValueChange($event)"
          (blur)="onFieldBlur($event)"
        />
      }

      <!-- Color Picker -->
      @if (field.type === 'color') {
        <dq-color-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          (valueChange)="onFieldValueChange($event)"
          (blur)="onFieldBlur($event)"
        />
      }

      <!-- Multi-Select -->
      @if (field.type === 'multiselect') {
        <dq-multiselect-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          [options]="getAvailableOptions(field)"
          [loading]="fieldLoading()[field.name]"
          [disabled]="isFieldDisabled(field)"
          (valueChange)="onFieldValueChange($event)"
          (blur)="onFieldBlur($event)"
        />
      }

      <!-- DateTime Picker -->
      @if (field.type === 'datetime') {
        <dq-datetime-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          (valueChange)="onFieldValueChange($event)"
          (blur)="onFieldBlur($event)"
        />
      }

      <!-- File Upload -->
      @if (field.type === 'file') {
        <dq-file-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          [filePreview]="getFilePreview(field.name)"
          [fileName]="getFileName(formValues()[field.name])"
          [fileSizeFormatted]="getFileSize(field.name)"
          [maxFileSizeFormatted]="field.maxFileSize ? formatFileSize(field.maxFileSize) : ''"
          [isImageFile]="isImage(formValues()[field.name])"
          (fileChange)="onFileChange($event)"
          (blur)="onFieldBlur($event)"
        />
      }

      <!-- Rich Text Editor (Basic) -->
      @if (field.type === 'richtext') {
        <dq-richtext-field
          [field]="field"
          [value]="formValues()[field.name]"
          [touched]="touched()[field.name] || false"
          [error]="errors()[field.name] || null"
          (valueChange)="onFieldValueChange($event)"
          (blur)="onFieldBlur($event)"
        />
      }

      <!-- Dynamic Field Array (Repeater) -->
      @if (field.type === 'array' && field.arrayConfig) {
        <dq-array-field
          [field]="field"
          [arrayIndices]="getArrayIndices(field.name)"
          [formValues]="formValues()"
          [touched]="touched()"
          [errors]="errors()"
          (addItem)="onArrayAddItem($event)"
          (removeItem)="onArrayRemoveItem($event)"
          (subFieldChange)="onArraySubFieldChange($event)"
          (subFieldBlur)="onArraySubFieldBlur($event)"
        />
      }

      <!-- DataTable -->
      @if (field.type === 'datatable' && field.tableConfig) {
      <div class="datatable-wrapper" [class.bordered]="field.tableConfig.bordered !== false" [class.dense]="field.tableConfig.dense">
          @if (field.tableConfig.showLabel !== false) {
          <label class="form-label">{{ field.label }}</label>
          }

        <!-- Search/Filter Bar -->
        @if (field.tableConfig.filter?.enabled) {
        <div class="datatable-search-bar">
          <input
            type="text"
            class="datatable-search-input"
            [placeholder]="field.tableConfig.filter?.placeholder || 'Search...'"
            (input)="filterTable(field.name, $any($event.target).value)"
            [value]="tableFilterTerm()[field.name] || ''"
          />
        </div>
        }

        <!-- Loading State -->
        @if (tableLoading()[field.name]) {
        <div class="datatable-loading">
          <div class="loading-spinner"></div>
          <span>Loading data...</span>
        </div>
        } @else {

        <!-- Table -->
        <div class="datatable-scroll">
          <table class="datatable"
                 [class.striped]="field.tableConfig.striped"
                 [class.hoverable]="field.tableConfig.hoverable !== false">
            <!-- Table Header -->
            <thead>
              <tr>
                <!-- Selection Column -->
                @if (field.tableConfig.selection?.enabled) {
                <th class="datatable-select-col">
                  @if (field.tableConfig.selection?.mode !== 'single' && field.tableConfig.selection?.showSelectAll !== false) {
                  <input
                    type="checkbox"
                    class="datatable-checkbox"
                    [checked]="isTableAllSelected(field.name, field)"
                    [indeterminate]="isTableIndeterminate(field.name, field)"
                    (change)="toggleTableSelectAll(field.name, field)"
                    aria-label="Select all rows"
                  />
                  }
                </th>
                }

                <!-- Data Columns -->
                @for (column of field.tableConfig.columns; track column.key) {
                <th
                  [style.width]="column.width"
                  [class.sortable]="column.sortable"
                  [class.text-center]="column.align === 'center'"
                  [class.text-right]="column.align === 'right'"
                  (click)="column.sortable && sortTableColumn(field.name, column.key)"
                >
                  <div class="datatable-header-content">
                    <span>{{ column.label }}</span>
                    @if (column.sortable && tableSortConfig()[field.name]?.column === column.key) {
                    <span class="sort-indicator">
                      {{ tableSortConfig()[field.name]?.direction === 'asc' ? '↑' : '↓' }}
                    </span>
                    }
                  </div>
                </th>
                }
              </tr>
            </thead>

            <!-- Table Body -->
            <tbody>
              @for (row of getTableRows(field); track row.id || $index) {
              <tr [class.selected]="isTableRowSelected(field.name, row.id!)">
                <!-- Selection Column -->
                @if (field.tableConfig.selection?.enabled) {
                <td class="datatable-select-col">
                  <input
                    type="checkbox"
                    class="datatable-checkbox"
                    [checked]="isTableRowSelected(field.name, row.id!)"
                    (change)="toggleTableRowSelection(field.name, row.id!)"
                    [attr.aria-label]="'Select row ' + row.id"
                  />
                </td>
                }

                <!-- Data Columns -->
                @for (column of field.tableConfig.columns; track column.key) {
                <td
                  [class.text-center]="column.align === 'center'"
                  [class.text-right]="column.align === 'right'"
                >
                  <!-- Text Column -->
                  @if (!column.type || column.type === 'text') {
                    {{ row[column.key] }}
                  }

                  <!-- Number Column -->
                  @if (column.type === 'number') {
                    {{ formatTableCell(row[column.key], column) }}
                  }

                  <!-- Currency Column -->
                  @if (column.type === 'currency') {
                    {{ formatTableCell(row[column.key], column) }}
                  }

                  <!-- Date Column -->
                  @if (column.type === 'date') {
                    {{ formatTableCell(row[column.key], column) }}
                  }

                  <!-- Badge Column -->
                  @if (column.type === 'badge') {
                    <span class="datatable-badge badge-{{ getBadgeColor(row[column.key], column) }}">
                      {{ row[column.key] }}
                    </span>
                  }

                  <!-- Avatar Column -->
                  @if (column.type === 'avatar') {
                    <div class="datatable-avatar-cell">
                      @if (row[column.avatarKey || column.key + 'Avatar']) {
                        <img
                          class="datatable-avatar"
                          [src]="row[column.avatarKey || column.key + 'Avatar']"
                          [alt]="row[column.key]"
                        />
                      } @else {
                        <div class="datatable-avatar-placeholder">
                          {{ getAvatarInitials(row[column.key]) }}
                        </div>
                      }
                      <span class="datatable-avatar-name">{{ row[column.key] }}</span>
                    </div>
                  }

                  <!-- Link Column -->
                  @if (column.type === 'link' && column.linkTemplate) {
                    <a
                      [href]="generateTableLink(row, column.linkTemplate)"
                      [target]="column.linkTarget || '_self'"
                      class="datatable-link"
                    >
                      {{ row[column.key] }}
                    </a>
                  }

                  <!-- Actions Column -->
                  @if (column.type === 'actions' && column.actions) {
                    <div class="datatable-actions">
                      <!-- Check if more than 3 visible actions -->
                      @if (getVisibleActionsCount(column.actions, row) > 3) {
                        <!-- Show overflow menu (three vertical dots) with all actions -->
                        <div class="datatable-action-menu">
                          <button
                            type="button"
                            class="datatable-action-menu-trigger datatable-action-overflow action-secondary"
                            (click)="toggleActionMenu(field.name + '_overflow', row.id!); $event.stopPropagation()"
                            title="More actions"
                          >
                            <span class="action-icon">⋮</span>
                          </button>

                          @if (isActionMenuOpen(field.name + '_overflow', row.id!)) {
                            <div class="datatable-action-dropdown">
                              @for (action of getVisibleActions(column.actions, row); track action.label) {
                                <!-- For button type actions in overflow menu -->
                                @if (!action.type || action.type === 'button') {
                                  <button
                                    type="button"
                                    class="datatable-action-dropdown-item"
                                    (click)="handleTableAction(action.onClick || action.label, row); closeActionMenu(field.name + '_overflow', row.id!)"
                                  >
                                    @if (action.icon) {
                                      <span class="action-icon">{{ action.icon }}</span>
                                    }
                                    <span>{{ action.label }}</span>
                                  </button>
                                }
                                <!-- For menu type actions in overflow menu, show menu items directly -->
                                @if (action.type === 'menu' && action.menuItems) {
                                  @for (subAction of action.menuItems; track subAction.label) {
                                    @if (isActionVisible(subAction, row)) {
                                      <button
                                        type="button"
                                        class="datatable-action-dropdown-item"
                                        (click)="handleTableAction(subAction.onClick || subAction.label, row); closeActionMenu(field.name + '_overflow', row.id!)"
                                      >
                                        @if (subAction.icon) {
                                          <span class="action-icon">{{ subAction.icon }}</span>
                                        }
                                        <span>{{ subAction.label }}</span>
                                      </button>
                                    }
                                  }
                                }
                              }
                            </div>
                          }
                        </div>
                      } @else {
                        <!-- Show actions normally (3 or fewer) -->
                        @for (action of column.actions; track action.label) {
                          <!-- Check visibility condition -->
                          @if (isActionVisible(action, row)) {
                            <!-- Button type action -->
                            @if (!action.type || action.type === 'button') {
                              <button
                                type="button"
                                class="datatable-action-btn action-{{ action.color || 'secondary' }}"
                                (click)="handleTableAction(action.onClick || action.label, row)"
                                [title]="action.label"
                              >
                                @if (action.icon) {
                                  <span class="action-icon">{{ action.icon }}</span>
                                }
                                @if (!action.icon || action.label) {
                                  <span class="action-label">{{ action.label }}</span>
                                }
                              </button>
                            }

                            <!-- Menu type action (dropdown) -->
                            @if (action.type === 'menu') {
                              <div class="datatable-action-menu">
                                <button
                                  type="button"
                                  class="datatable-action-menu-trigger action-{{ action.color || 'secondary' }}"
                                  (click)="toggleActionMenu(field.name, row.id!); $event.stopPropagation()"
                                  [title]="action.label"
                                >
                                  @if (action.icon) {
                                    <span class="action-icon">{{ action.icon }}</span>
                                  }
                                  @if (!action.icon || action.label) {
                                    <span class="action-label">{{ action.label }}</span>
                                  }
                                  <span class="menu-arrow">▼</span>
                                </button>

                                @if (isActionMenuOpen(field.name, row.id!)) {
                                  <div class="datatable-action-dropdown">
                                    @for (subAction of action.menuItems; track subAction.label) {
                                      @if (isActionVisible(subAction, row)) {
                                        <button
                                          type="button"
                                          class="datatable-action-dropdown-item"
                                          (click)="handleTableAction(subAction.onClick || subAction.label, row); closeActionMenu(field.name, row.id!)"
                                        >
                                          @if (subAction.icon) {
                                            <span class="action-icon">{{ subAction.icon }}</span>
                                          }
                                          <span>{{ subAction.label }}</span>
                                        </button>
                                      }
                                    }
                                  </div>
                                }
                              </div>
                            }
                          }
                        }
                      }
                    </div>
                  }
                </td>
                }
              </tr>
              }

              <!-- Empty State -->
              @if (getTableRows(field).length === 0) {
              <tr class="datatable-empty-row">
                <td [attr.colspan]="field.tableConfig.columns.length + (field.tableConfig.selection?.enabled ? 1 : 0)">
                  <div class="datatable-empty-state">
                    {{ field.tableConfig.emptyMessage || 'No data available' }}
                  </div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        @if (field.tableConfig.pagination?.enabled !== false && getTableTotalRows(field) > 0) {
        <div class="datatable-pagination">
          <!-- Rows per page selector -->
          <div class="datatable-rows-per-page">
            <label>Rows per page:</label>
            <select
              class="datatable-select"
              [value]="tableRowsPerPage()[field.name] || 10"
              (change)="changeTableRowsPerPage(field.name, Number($any($event.target).value))"
            >
              @for (option of field.tableConfig.pagination?.rowsPerPageOptions || [10, 25, 50, 100]; track option) {
                <option [value]="option">{{ option }}</option>
              }
            </select>
          </div>

          <!-- Pagination info -->
          @if (field.tableConfig.pagination?.showPageInfo !== false) {
          <div class="datatable-pagination-info">
            {{ getTablePaginationInfo(field) }}
          </div>
          }

          <!-- Page navigation -->
          <div class="datatable-pagination-controls">
            <!-- First page button -->
            <button
              type="button"
              class="datatable-page-btn"
              [disabled]="(tableCurrentPage()[field.name] || 1) === 1"
              (click)="goToTablePage(field.name, 1)"
              aria-label="First page"
            >
              «
            </button>

            <!-- Previous page button -->
            <button
              type="button"
              class="datatable-page-btn"
              [disabled]="(tableCurrentPage()[field.name] || 1) === 1"
              (click)="goToTablePage(field.name, (tableCurrentPage()[field.name] || 1) - 1)"
              aria-label="Previous page"
            >
              ‹
            </button>

            <!-- Page numbers -->
            @for (pageNum of getTablePageNumbers(field); track pageNum) {
              <button
                type="button"
                class="datatable-page-btn"
                [class.active]="pageNum === (tableCurrentPage()[field.name] || 1)"
                (click)="goToTablePage(field.name, pageNum)"
                [attr.aria-label]="'Page ' + pageNum"
              >
                {{ pageNum }}
              </button>
            }

            <!-- Next page button -->
            <button
              type="button"
              class="datatable-page-btn"
              [disabled]="(tableCurrentPage()[field.name] || 1) === getTableTotalPages(field)"
              (click)="goToTablePage(field.name, (tableCurrentPage()[field.name] || 1) + 1)"
              aria-label="Next page"
            >
              ›
            </button>

            <!-- Last page button -->
            <button
              type="button"
              class="datatable-page-btn"
              [disabled]="(tableCurrentPage()[field.name] || 1) === getTableTotalPages(field)"
              (click)="goToTablePage(field.name, getTableTotalPages(field))"
              aria-label="Last page"
            >
              »
            </button>
          </div>
        </div>
        }
        }
      </div>
      }

      <!-- Timeline -->
      @if (field.type === 'timeline' && field.timelineConfig) {
      <div class="timeline-wrapper {{ getTimelineLayoutClass(field.timelineConfig) }}">
        <label class="form-label">{{ field.label }}</label>

        <!-- Loading State -->
        @if (timelineLoading()[field.name]) {
        <div class="timeline-loading">
          <div class="loading-spinner"></div>
          <span>Loading timeline...</span>
        </div>
        } @else {
          <!-- Non-grouped Timeline -->
          @if (!field.timelineConfig.grouping?.enabled) {
          <div class="timeline-container" [class.show-connector]="shouldShowTimelineConnector(field.timelineConfig)">
            @for (item of getTimelineItems(field); track item.id; let isLast = $last) {
            <div class="timeline-item"
                 [class.expanded]="isTimelineItemExpanded(field.name, item.id)"
                 [class.clickable]="field.timelineConfig.interaction?.clickable || field.timelineConfig.interaction?.expandable"
                 [class.position-left]="item.position === 'left'"
                 [class.position-right]="item.position === 'right'"
                 [class.position-center]="item.position === 'center'"
                 [class.status-completed]="item.status === 'completed'"
                 [class.status-in-progress]="item.status === 'in-progress'"
                 [class.status-pending]="item.status === 'pending'"
                 [class.status-cancelled]="item.status === 'cancelled'"
                 (click)="field.timelineConfig.interaction?.clickable || field.timelineConfig.interaction?.expandable ? handleTimelineItemClick(field, item) : null">

              <!-- Timestamp (for left alignment) -->
              @if (field.timelineConfig.style?.alignment === 'left' && item.timestamp) {
              <div class="timeline-timestamp">
                {{ formatTimelineDate(item.timestamp, field.timelineConfig.dateFormat) }}
              </div>
              }

              <!-- Marker/Connector -->
              <div class="timeline-marker-wrapper">
                <div class="timeline-marker {{ getTimelineMarkerClass(item) }}">
                  @if (field.timelineConfig.style?.markerStyle === 'icon' && item.icon) {
                  <span class="timeline-marker-icon">{{ item.icon }}</span>
                  } @else if (field.timelineConfig.style?.markerStyle === 'number') {
                  <span class="timeline-marker-number">{{ $index + 1 }}</span>
                  }
                </div>
              </div>

              <!-- Content -->
              <div class="timeline-content">
                <!-- Card Header (for card style) -->
                @if (field.timelineConfig.style?.cardStyle) {
                <div class="timeline-card">
                  <div class="timeline-card-header">
                    <div class="timeline-card-title-row">
                      <h4 class="timeline-title">{{ item.title }}</h4>
                      @if (item.badge) {
                      <span class="timeline-badge {{ getTimelineBadgeClass(item.badge) }}">
                        {{ item.badge.label }}
                      </span>
                      }
                    </div>
                    @if (item.timestamp && field.timelineConfig.style?.alignment !== 'left') {
                    <div class="timeline-date">
                      {{ formatTimelineDate(item.timestamp, field.timelineConfig.dateFormat) }}
                    </div>
                    }
                  </div>

                  @if (item.description) {
                  <div class="timeline-card-body">
                    <p class="timeline-description">{{ item.description }}</p>
                  </div>
                  }

                  @if (item.metadata && item.metadata.length > 0) {
                  <div class="timeline-metadata">
                    @for (meta of item.metadata; track meta.key) {
                    <div class="timeline-metadata-item">
                      @if (meta.icon) {
                      <span class="metadata-icon">{{ meta.icon }}</span>
                      }
                      <span class="metadata-key">{{ meta.key }}:</span>
                      <span class="metadata-value">{{ meta.value }}</span>
                    </div>
                    }
                  </div>
                  }

                  @if (item.link) {
                  <div class="timeline-card-footer">
                    <a [href]="item.link.url" [target]="item.link.target || '_self'" class="timeline-link">
                      @if (item.link.icon) {
                      <span class="link-icon">{{ item.link.icon }}</span>
                      }
                      {{ item.link.label || 'View details' }}
                    </a>
                  </div>
                  }
                </div>
                } @else {
                  <!-- Simple Content (non-card style) -->
                  <div class="timeline-simple-content">
                    <div class="timeline-header">
                      <h4 class="timeline-title">{{ item.title }}</h4>
                      @if (item.badge) {
                      <span class="timeline-badge {{ getTimelineBadgeClass(item.badge) }}">
                        {{ item.badge.label }}
                      </span>
                      }
                    </div>

                    @if (item.timestamp && field.timelineConfig.style?.alignment !== 'left') {
                    <div class="timeline-date">
                      {{ formatTimelineDate(item.timestamp, field.timelineConfig.dateFormat) }}
                    </div>
                    }

                    @if (item.description) {
                    <p class="timeline-description">{{ item.description }}</p>
                    }

                    @if (item.metadata && item.metadata.length > 0) {
                    <div class="timeline-metadata">
                      @for (meta of item.metadata; track meta.key) {
                      <div class="timeline-metadata-item">
                        @if (meta.icon) {
                        <span class="metadata-icon">{{ meta.icon }}</span>
                        }
                        <span class="metadata-key">{{ meta.key }}:</span>
                        <span class="metadata-value">{{ meta.value }}</span>
                      </div>
                      }
                    </div>
                    }

                    @if (item.link) {
                    <a [href]="item.link.url" [target]="item.link.target || '_self'" class="timeline-link">
                      @if (item.link.icon) {
                      <span class="link-icon">{{ item.link.icon }}</span>
                      }
                      {{ item.link.label || 'View details' }}
                    </a>
                    }
                  </div>
                }
              </div>
            </div>
            }

            <!-- Empty State -->
            @if (getTimelineItems(field).length === 0) {
            <div class="timeline-empty">
              <p>{{ field.timelineConfig.emptyMessage || 'No timeline items' }}</p>
            </div>
            }
          </div>
          }

          <!-- Grouped Timeline -->
          @if (field.timelineConfig.grouping?.enabled) {
          <div class="timeline-grouped-container">
            @for (group of getGroupedTimelineItems(field.name) | keyvalue; track group.key) {
            <div class="timeline-group">
              @if (field.timelineConfig.grouping?.showGroupLabels !== false) {
              <div class="timeline-group-label">
                {{ formatGroupLabel(group.key, field.timelineConfig) }}
              </div>
              }

              <div class="timeline-container" [class.show-connector]="shouldShowTimelineConnector(field.timelineConfig)">
                @for (item of group.value; track item.id; let isLast = $last) {
                <div class="timeline-item"
                     [class.expanded]="isTimelineItemExpanded(field.name, item.id)"
                     [class.clickable]="field.timelineConfig.interaction?.clickable || field.timelineConfig.interaction?.expandable"
                     [class.position-left]="item.position === 'left'"
                     [class.position-right]="item.position === 'right'"
                     [class.status-completed]="item.status === 'completed'"
                     [class.status-in-progress]="item.status === 'in-progress'"
                     [class.status-pending]="item.status === 'pending'"
                     [class.status-cancelled]="item.status === 'cancelled'"
                     (click)="field.timelineConfig.interaction?.clickable || field.timelineConfig.interaction?.expandable ? handleTimelineItemClick(field, item) : null">

                  <!-- Timestamp (for left alignment) -->
                  @if (field.timelineConfig.style?.alignment === 'left' && item.timestamp) {
                  <div class="timeline-timestamp">
                    {{ formatTimelineDate(item.timestamp, field.timelineConfig.dateFormat) }}
                  </div>
                  }

                  <!-- Marker/Connector -->
                  <div class="timeline-marker-wrapper">
                    <div class="timeline-marker {{ getTimelineMarkerClass(item) }}">
                      @if (field.timelineConfig.style?.markerStyle === 'icon' && item.icon) {
                      <span class="timeline-marker-icon">{{ item.icon }}</span>
                      } @else if (field.timelineConfig.style?.markerStyle === 'number') {
                      <span class="timeline-marker-number">{{ $index + 1 }}</span>
                      }
                    </div>
                  </div>

                  <!-- Content -->
                  <div class="timeline-content">
                    <!-- Card Style -->
                    @if (field.timelineConfig.style?.cardStyle) {
                    <div class="timeline-card">
                      <div class="timeline-card-header">
                        <div class="timeline-card-title-row">
                          <h4 class="timeline-title">{{ item.title }}</h4>
                          @if (item.badge) {
                          <span class="timeline-badge {{ getTimelineBadgeClass(item.badge) }}">
                            {{ item.badge.label }}
                          </span>
                          }
                        </div>
                        @if (item.timestamp && field.timelineConfig.style?.alignment !== 'left') {
                        <div class="timeline-date">
                          {{ formatTimelineDate(item.timestamp, field.timelineConfig.dateFormat) }}
                        </div>
                        }
                      </div>

                      @if (item.description) {
                      <div class="timeline-card-body">
                        <p class="timeline-description">{{ item.description }}</p>
                      </div>
                      }

                      @if (item.metadata && item.metadata.length > 0) {
                      <div class="timeline-metadata">
                        @for (meta of item.metadata; track meta.key) {
                        <div class="timeline-metadata-item">
                          @if (meta.icon) {
                          <span class="metadata-icon">{{ meta.icon }}</span>
                          }
                          <span class="metadata-key">{{ meta.key }}:</span>
                          <span class="metadata-value">{{ meta.value }}</span>
                        </div>
                        }
                      </div>
                      }

                      @if (item.link) {
                      <div class="timeline-card-footer">
                        <a [href]="item.link.url" [target]="item.link.target || '_self'" class="timeline-link">
                          @if (item.link.icon) {
                          <span class="link-icon">{{ item.link.icon }}</span>
                          }
                          {{ item.link.label || 'View details' }}
                        </a>
                      </div>
                      }
                    </div>
                    } @else {
                      <!-- Simple Content -->
                      <div class="timeline-simple-content">
                        <div class="timeline-header">
                          <h4 class="timeline-title">{{ item.title }}</h4>
                          @if (item.badge) {
                          <span class="timeline-badge {{ getTimelineBadgeClass(item.badge) }}">
                            {{ item.badge.label }}
                          </span>
                          }
                        </div>

                        @if (item.timestamp && field.timelineConfig.style?.alignment !== 'left') {
                        <div class="timeline-date">
                          {{ formatTimelineDate(item.timestamp, field.timelineConfig.dateFormat) }}
                        </div>
                        }

                        @if (item.description) {
                        <p class="timeline-description">{{ item.description }}</p>
                        }

                        @if (item.metadata && item.metadata.length > 0) {
                        <div class="timeline-metadata">
                          @for (meta of item.metadata; track meta.key) {
                          <div class="timeline-metadata-item">
                            @if (meta.icon) {
                            <span class="metadata-icon">{{ meta.icon }}</span>
                            }
                            <span class="metadata-key">{{ meta.key }}:</span>
                            <span class="metadata-value">{{ meta.value }}</span>
                          </div>
                          }
                        </div>
                        }

                        @if (item.link) {
                        <a [href]="item.link.url" [target]="item.link.target || '_self'" class="timeline-link">
                          @if (item.link.icon) {
                          <span class="link-icon">{{ item.link.icon }}</span>
                          }
                          {{ item.link.label || 'View details' }}
                        </a>
                        }
                      </div>
                    }
                  </div>
                </div>
                }
              </div>
            </div>
            }
          </div>
          }
        }
      </div>
      }

      <!-- Error -->
      @if (touched()[field.name] && errors()[field.name]) {
      <div [id]="'error-' + field.name" class="error" role="alert" aria-live="assertive">
        {{ errors()[field.name] }}
      </div>
      }
    </div>
    }
    }
    </div>

    <!-- Submission Error Message -->
    @if (submitError()) {
    <div class="submission-error" role="alert" aria-live="assertive">
      <strong>Error:</strong> {{ submitError() }}
      @if (submitRetryCount() > 0) {
      <p class="retry-info">Retry attempt {{ submitRetryCount() }} of {{ 3 }}</p>
      }
      <button type="button" class="retry-btn" (click)="retrySubmit()">
        Retry Submission
      </button>
    </div>
    }

    <!-- Navigation Buttons -->
    <dq-multi-step-navigation
      [sections]="sections()"
      [currentStep]="currentStep()"
      [completedSteps]="completedSteps()"
      [showProgress]="false"
      [showNavigation]="multiStepEnabled()"
      [showSubmitButton]="shouldShowSubmitButton()"
      [isValid]="isValid()"
      [submitting]="submitting()"
      [retryCount]="submitRetryCount()"
      (stepClick)="goToStep($event)"
      (nextClick)="goToNextStep()"
      (previousClick)="goToPreviousStep()"
      (submitClick)="saveUserData()"
    />
  </form>
</div>
}

<!-- Success / Submitted Data -->
@if (submitted() && submitSuccess()) {
<div class="submitted-data success-message" role="status" aria-live="polite">
  <div class="success-icon">✓</div>
  <h3>Form Submitted Successfully!</h3>

  @if (submittedData()) {
  <ul>
    @for (field of fields(); track field.name) {
    <li>
      <strong>{{ field.label }}</strong>
      <span>{{ submittedData()?.[field.name] }}</span>
    </li>
    }
  </ul>
  }
</div>
}
